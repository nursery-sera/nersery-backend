<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <script>
    // APIのベースURL（ここに注文データをPOSTします）
    window.API_BASE = 'https://www.nurserysera.com/api';
  </script>
  <meta name="viewport" content="width=950, user-scalable=no">
  <title>nursery sera — ご注文フォーム</title>
  <link href="https://fonts.googleapis.com/css2?family=Bayon&family=Tangerine:wght@700&family=Italianno&display=swap" rel="stylesheet">
  <style>
    /* ===== ベース（下のコードの見た目を踏襲） ===== */
    html, body {
      margin: 0; padding: 0; font-size: 20px; -webkit-text-size-adjust: 100%;
      font-family: Arial, sans-serif; background:#ffffff; color:#333; box-sizing: border-box; min-height:100vh; scroll-behavior:smooth;
    }
    *, *::before, *::after { box-sizing: inherit; }

    /* ===== ヘッダー/メニュー（下のコード） ===== */
    .header-bar { position: sticky; top: -50px; z-index: 1000; background: transparent; display:flex; align-items:center; justify-content:space-between; padding:20px; transition: top 0.5s ease; }
    .menu-icon { display:flex; flex-direction:column; justify-content:space-between; width:48px; height:40px; cursor:pointer; background:none; border:none; padding:0; margin:0; transform: translateX(20px); }
    .menu-icon span { display:block; height:3px; width:100%; background-color:#333; border-radius:2px; }
    .main-title { font-family:'Bayon', cursive; font-size:120px; margin:0; white-space:nowrap; transform: translateX(20px); }
    .cart-button { background-image:url('https://gist.githubusercontent.com/nursery-sera/3bfad5863718f7147d193844bdaca462/raw/d7f9244ea2cbbaf4c13a67c30831022e37076b17/plantcart-icon.svg'); background-size:contain; background-repeat:no-repeat; width:100px; height:100px; border:none; background-color:transparent; cursor:pointer; }

    .overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; display:none; }
    .overlay.show { display:block; }

      .category-menu{
      position:fixed; top:0; left:0;
      width:55vw; height:100vh;
      background-color:rgba(255,255,255,.7);
      backdrop-filter:blur(8px);
      z-index:3000;
      border:2px solid rgba(0,0,0,.1);
      box-shadow:4px 0 20px rgba(0,0,0,.2);
      transform:translateX(-100%); opacity:0; pointer-events:none;
      transition:transform .4s ease, opacity .4s ease;
      padding:30px;
    }
    .category-menu.show{
      transform:translateX(0); opacity:1; pointer-events:auto;
    }

    .category-header{
      font-family:'Cinzel', serif;
      font-size:80px; margin-bottom:40px; letter-spacing:3px; color:#000;
      text-align:center;
    }
    .category-menu ul{ list-style:none; padding:0; margin:0; }
    .category-menu li{opacity: 0.8;
font-family: 'Noto Serif JP', serif;
      font-size:36px; margin:20px 0; padding-bottom:10px; position:relative;
      border-bottom:1px solid rgba(0,0,0,.1);
      transition:transform .2s ease, color .2s ease;
      cursor:pointer; font-weight:400; color:#000; text-align:left; padding-right:20px;
    }
    .category-menu li:hover{ color:#c2185b; transform:scale(1.05); }
    .category-menu li::after{
      content:"＞"; position:absolute; right:0; top:2px; color:#bbb; font-size:20px;
    }

.category-subtitle {
  font-size: 48px;
  font-family: 'Playfair Display SC', serif;
  margin: 66px 0 10px;
  color: #000000;
  font-weight: 400;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  padding-bottom: 4px;
text-align:center;
}
.contact-links a {
  color: #000;     
  text-decoration: none; /* 下線消し */
}


    /* ===== フッター（下のコード） ===== */
    footer { margin-top:100px; padding:30px 20px; background:#fff; text-align:center; }
    .footer-icons { display:flex; justify-content:center; gap:60px; margin-bottom:16px; }
    .footer-icons img { width:42px; height:42px; }
    .footer-links a { display:inline-block; margin:0 20px; color:#444; font-size:24px; text-decoration:none; }
    .footer-links a:hover { text-decoration: underline; }

    /* ===== 見出し ===== */
    .subtitle-x { font-family:'Tangerine', cursive; font-size:100px; opacity:.6; margin-top:-30px; text-align:center;color: #555555;}
    .subtitle {  font-family:'Tangerine', cursive;font-size:44px; opacity:1; margin:66px 0 -10px; text-align:center; color: #888 !important;font-weight: 300;}

    /* ===== 入力フォーム（上のコード準拠。背景色に馴染むよう label 背景は inherit） ===== */
    form{ width:100vw; padding:0 5vw; }
    .form-group{ position:relative; margin-top:48px; }
    .form-group input, .form-group textarea{
      width:100%; padding:28px 12px 12px 12px; font-size:42px; border:none; border-bottom:2px solid #aaa; background:transparent; outline:none;
      font-weight:300;
    }
    .form-group textarea{ min-height:6em; resize:vertical; }
    .form-group label{ position:absolute; left:12px; top:22px; color:#888; background: inherit; padding:0 6px; transition:.2s ease; pointer-events:none; font-size:36px; }
    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label,
    .form-group textarea:focus + label,
    .form-group textarea:not(:placeholder-shown) + label{ top:-16px; left:8px; font-size:28px; color:#444; }

    /* PHの見え方（押したら両方見せる用途） */
    input::placeholder{ opacity:0; transition:opacity .2s ease; }
    input:focus::placeholder{ opacity:1; }
    .ph-on::placeholder{ opacity:1 !important; }

    .row{ display:flex; gap:16px; }
    .row .form-group{ flex:1; margin-top:48px; }

    .zip-btn{ opacity: 0.9;position:absolute; right:0; top:0; height:100%; font-size:36px; padding:0 20px; background:#fff; color:#888; border: 2px solid #888; cursor:pointer; border-radius:0px; font-weight:400; transform: translate(0px, -2px);}

    /* 都道府県：カスタムリスト */
    .pref-wrap{ position:relative; }
    .pref-list{ position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #aaa; z-index:9999; max-height:280px; overflow:auto; display:none; }
    .pref-list button{ display:block; width:100%; text-align:left; background:#fff; border:0; padding:12px; font-size:32px; cursor:pointer; border-bottom:1px solid #eee; }
    .pref-list button:hover{ background:#f7f7f7; }

    .submit-button {
   display: block;
  width: fit-content;
  margin: 50px auto 0; 
  background: none;   /* 背景なし */
  border: none;       /* 枠なし */
  padding: 0;         /* 余白なし */
  font-size: 52px;
  font-weight: 200;
color: #333;     /* グレー継承 */
  cursor: pointer;
opacity: 0.8;
  text-decoration: none;
  border-bottom: 1.4px solid currentColor;
  padding-bottom: 6px;
  margin-top: 100px;
margin-left: 37%;

}


    @media (min-width:1024px){
      html{ font-size:16px; }
      .main-title{ font-size:100px; }
      .subtitle{ font-size:20px; }
      form{ max-width:720px; margin:0 auto; padding:0 32px; }
      .form-group input,.form-group textarea{ font-size:16px; padding:12px 10px; }
      .form-group label{ font-size:14px; top:14px; }
      .form-group input:focus + label,
      .form-group input:not(:placeholder-shown) + label,
      .form-group textarea:focus + label,
      .form-group textarea:not(:placeholder-shown) + label{ font-size:12px; top:-10px; }
      .zip-btn{ font-size:14px; padding:0 14px; }
      .pref-list button{ font-size:14px; }}



   
  </style>
</head>
<body>
  <? var url = getScriptUrl(); ?>
  <!-- ===== ヘッダー（下のコード） ===== -->
  <div class="header-bar" id="titleBar">
    <div class="menu-icon" onclick="toggleMenu(event)">
      <span></span><span></span><span></span>
    </div>
    <div class="main-title" onclick="window.top.location.href='<?= url ?>?page=index'">nursery sera</div>
    <button class="cart-button" onclick="window.top.location.href='<?= url ?>?page=cart'"></button>
  </div>
   <div class="category-menu" id="categoryMenu">
    <h1 class="category-header">MENU</h1>
<h2 class="category-subtitle">Category</h2>
    <ul>
      <li onclick="go('/?page=index')">All</li>
      <li onclick="go('/?page=index&liked=1')">like♡</li>
      <li onclick="go('/?page=index&cat=monstera')">Monstera</li>
      <li onclick="go('/?page=index&cat=alocasia')">Alocasia</li>
      <li onclick="go('/?page=index&cat=anthurium')">Anthurium</li>
      <li onclick="go('/?page=index&cat=philodendron')">Philodendron</li>
</ul>
<h2 class="category-subtitle">Contact</h2>
<ul class="contact-links">
  <li><a href="https://www.instagram.com/nursery_sera?igsh=cWx2cTZ3cWNicGlz&utm_source=" target="_blank">Instagram</a></li>
  <li><a href="https://lin.ee/mFSu5FS" target="_blank">LINE</a></li>
  <li><a href="https://www.threads.net/@nursery_sera?igshid=NTc4MTIwNjQ2YQ==" target="_blank">Threads</a></li>
  <li><a href="/?page=policy">お問い合わせ</a></li>
</ul>
  </div>
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- ===== 見出し ===== -->
  <p class="subtitle-x">order form</p>
  <p class="subtitle">配送先住所</p>

  <!-- ===== 入力フォーム（上のコード：カナ自動なし版） ===== -->
  <form id="contact-form">
    <!-- お名前（姓/名） -->
    <div class="row">
      <div class="form-group">
        <input id="lastName" name="lastName" type="text" placeholder="お名前" autocomplete="family-name" required>
        <label id="nameMasterLabel">お名前</label>
      </div>
      <div class="form-group">
        <input id="firstName" name="firstName" type="text" placeholder="" autocomplete="given-name" required>
        <label></label>
      </div>
    </div>

    <!-- フリガナ（手入力。自動変換なし） -->
    <div class="row">
      <div class="form-group">
        <input id="lastKana" name="lastKana" type="text" placeholder="フリガナ（セイ）" required>
        <label id="kanaMasterLabel">フリガナ</label>
      </div>
      <div class="form-group">
        <input id="firstKana" name="firstKana" type="text" placeholder="フリガナ（メイ）" required>
        <label></label>
      </div>
    </div>

    <!-- 郵便番号 + 自動入力 -->
    <div class="form-group">
      <input type="text" id="zipcode" name="zipcode" placeholder="例:1234567(ハイフンなし)" maxlength="7" required>
      <label>郵便番号</label>
      <button type="button" class="zip-btn" id="zipBtn">住所自動入力</button>
    </div>

    <!-- 都道府県（カスタムリスト表示） -->
    <div class="form-group pref-wrap">
      <input type="text" id="prefecture" name="prefecture" placeholder=" " required readonly>
      <label>都道府県</label>
      <div class="pref-list" id="prefList"></div>
    </div>

    <!-- 市区町村（＝ address2：市/区 のみ） -->
    <div class="form-group">
      <input type="text" id="city" name="city" placeholder=" " required>
      <label>市区町村</label>
    </div>

    <!-- 番地（＝ address3：町名 を自動入力／番地以降はユーザー追記） -->
    <div class="form-group">
      <input type="text" id="address" name="address" placeholder=" ">
      <label>町名・番地</label>
    </div>

    <!-- 建物名 -->
    <div class="form-group">
      <input type="text" id="building" name="building" placeholder=" ">
      <label>建物名・部屋番号</label>
    </div>

    <!-- メール -->
    <div class="form-group">
      <input type="email" id="email" name="email" placeholder=" " required autocomplete="email">
      <label>連絡用メールアドレス</label>
    </div>

    <!-- お支払い方法 -->
    <div class="form-group">
      <input type="text" id="payment" name="payment" value="銀行振込（PayPay銀行）" readonly placeholder=" ">
      <label>お支払い方法</label>
    </div>

    <!-- 備考 -->
    <div class="form-group">
      <textarea id="memo" name="memo" placeholder=" "></textarea>
      <label>備考【任意】</label>
     <div style="text-align:left; font-size:20px; line-height:1.7; font-weight:200; margin-top:14px;">
          <div>※発送方法：第四種郵便 速達 特定記録（追跡番号付き）</div>
          <div>※お支払い方法：銀行振込（PayPay銀行）</div>
         
          <div>※局留め希望の方は備考欄に「〇〇郵便局 局留め」と記載してください。</div>
        </div>

    <button type="submit" <button type="submit" id="submitBtn" class="submit-button" aria-busy="false">注文送信 ></button>
  </form>



  <!-- ===== フッター（下のコード） ===== -->
  <footer>
    
    <div class="footer-links">
      <a href="<?= url ?>?page=policy">ポリシー</a>
      <a href="<?= url ?>?page=policy">利用規約</a>
      <a href="<?= url ?>?page=policy">特定商取引法に基づく表記</a>
      <a href="<?= url ?>?page=policy">お問い合わせ</a>
    </div>
  </footer>

<script>
  // 画面遷移ヘルパー（使っていれば）
  (function(){
    const BASE = window.location.origin;
    window.go = function(path){ window.top.location.href = new URL(path, BASE).toString(); };
  })();

  /* ====== メニュー ====== */
  (function(){
    function toggleMenu() {
      var menu = document.getElementById("categoryMenu");
      var overlay = document.getElementById("overlay");
      if (!menu || !overlay) return;
      var isVisible = menu.classList.contains("show");
      document.body.style.overflow = isVisible ? "" : "hidden";
      menu.classList.toggle("show", !isVisible);
      overlay.classList.toggle("show", !isVisible);
    }
    function closeMenu() {
      var menu = document.getElementById("categoryMenu");
      var overlay = document.getElementById("overlay");
      if (!menu || !overlay) return;
      menu.classList.remove("show");
      overlay.classList.remove("show");
      document.body.style.overflow = "";
    }
    window.toggleMenu = toggleMenu;
    window.closeMenu  = closeMenu;

    // スクロールでヘッダー表示/非表示
    var lastScrollY = window.scrollY || 0;
    var titleBar = document.getElementById("titleBar");
    var threshold = 10;
    window.addEventListener("scroll", function() {
      if (!titleBar) return;
      var currentScrollY = window.scrollY || 0;
      var diff = currentScrollY - lastScrollY;
      if (Math.abs(diff) >= threshold) {
        titleBar.style.top = diff < 0 ? "-50px" : "-200px";
        lastScrollY = currentScrollY;
      }
    });
  })();

  /* ====== プレースホルダー連動 ====== */
  (function(){
    var lastName  = document.getElementById('lastName');
    var firstName = document.getElementById('firstName');
    var nameMasterLabel = document.getElementById('nameMasterLabel');

    function resetNamePHIfEmpty(){
      var noFocus = document.activeElement !== lastName && document.activeElement !== firstName;
      if (noFocus && lastName && firstName && !lastName.value.trim() && !firstName.value.trim()){
        lastName.placeholder = 'お名前';
        firstName.placeholder = '';
        lastName.classList.remove('ph-on');
        firstName.classList.remove('ph-on');
      }
    }
    function activateNamePH(){
      if (!lastName || !firstName) return;
      lastName.placeholder='姓';
      firstName.placeholder='名';
      lastName.classList.add('ph-on');
      firstName.classList.add('ph-on');
    }
    if (lastName)  lastName.addEventListener('focus', activateNamePH);
    if (firstName) firstName.addEventListener('focus', activateNamePH);
    if (nameMasterLabel) nameMasterLabel.addEventListener('click', function(){ if(lastName){ lastName.focus(); activateNamePH(); }});

    [lastName, firstName].forEach(function(el){
      if (!el) return;
      el.addEventListener('blur', function(){ setTimeout(resetNamePHIfEmpty, 0); });
    });

    // --- フリガナ ---
    var lastKana  = document.getElementById('lastKana');
    var firstKana = document.getElementById('firstKana');
    var kanaMasterLabel = document.getElementById('kanaMasterLabel');

    function resetKanaPHIfEmpty(){
      var noFocus = document.activeElement !== lastKana && document.activeElement !== firstKana;
      if (noFocus && lastKana && firstKana && !lastKana.value.trim() && !firstKana.value.trim()){
        lastKana.placeholder = 'フリガナ（セイ）';
        firstKana.placeholder = 'フリガナ（メイ）';
        lastKana.classList.remove('ph-on');
        firstKana.classList.remove('ph-on');
      }
    }
    function activateKanaPH(){
      if (!lastKana || !firstKana) return;
      lastKana.placeholder='セイ';
      firstKana.placeholder='メイ';
      lastKana.classList.add('ph-on');
      firstKana.classList.add('ph-on');
    }
    if (lastKana)  lastKana.addEventListener('focus', activateKanaPH);
    if (firstKana) firstKana.addEventListener('focus', activateKanaPH);
    if (kanaMasterLabel) kanaMasterLabel.addEventListener('click', function(){ if(lastKana){ lastKana.focus(); activateKanaPH(); }});

    [lastKana, firstKana].forEach(function(el){
      if (!el) return;
      el.addEventListener('blur', function(){ setTimeout(resetKanaPHIfEmpty, 0); });
    });

// カタカナ自動変換（IME重複対策つき）
function toKatakana(str) {
  return str.replace(/[\u3041-\u3096]/g, function(ch) {
    return String.fromCharCode(ch.charCodeAt(0) + 0x60);
  });
}

function attachKanaAutoKatakana(el){
  if (!el) return;
  let composing = false;

  el.addEventListener('compositionstart', () => { composing = true; });
  el.addEventListener('compositionend', (e) => {
    composing = false;
    e.target.value = toKatakana(e.target.value);
  });

  el.addEventListener('input', (e) => {
    if (composing) return; // 変換中は触らない
    const v = e.target.value;
    const conv = toKatakana(v);
    if (v !== conv){
      const pos = e.target.selectionStart;
      e.target.value = conv;
      try { e.target.setSelectionRange(pos, pos); } catch(_) {}
    }
  });

  el.addEventListener('blur', (e) => {
    e.target.value = toKatakana(e.target.value.trim());
  });
}

attachKanaAutoKatakana(document.getElementById('lastKana'));
attachKanaAutoKatakana(document.getElementById('firstKana'));
})();
  /* ====== 郵便番号 → 住所 ====== */
  (function(){
    var prefInput = document.getElementById('prefecture');
    var prefList  = document.getElementById('prefList');
    var zipBtn    = document.getElementById('zipBtn');

    function setPrefecture(p){ if (prefInput) prefInput.value = p; }
    window.setPrefecture = setPrefecture;

    if (zipBtn) {
      zipBtn.addEventListener('click', function(){
        var zipEl = document.getElementById('zipcode');
        var zip = (zipEl && zipEl.value ? zipEl.value : '').trim();
        if (!/^\d{7}$/.test(zip)) { alert('正しい7桁の郵便番号を入力してください'); return; }
        fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + zip)
          .then(function(r){ return r.json(); })
          .then(function(data){
            if (!data.results) { alert('住所が見つかりませんでした。'); return; }
            var r = data.results[0];
            setPrefecture(r.address1);
            var city = document.getElementById('city');
            var addr = document.getElementById('address');
            if (city) city.value = (r.address2 || '');
            if (addr) addr.value = (r.address3 || '');
          })
          .catch(function(){ alert('検索エラー'); });
      });
    }

    // 都道府県リスト
    var PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
    if (prefInput && prefList){
      PREFS.forEach(function(p){
        var b=document.createElement('button');
        b.type='button'; b.textContent=p;
        b.addEventListener('click', function(){ setPrefecture(p); hidePrefList(); });
        prefList.appendChild(b);
      });
      function showPrefList(){ prefList.style.display='block'; }
      function hidePrefList(){ prefList.style.display='none'; }
      prefInput.addEventListener('click', function(e){ e.stopPropagation(); (prefList.style.display==='block'?hidePrefList():showPrefList()); });
      document.addEventListener('click', hidePrefList);
    }
  })();

/* ====== 送信（APIへPOST） ====== */
(function(){
  const API = (window.API_BASE || '') + '/orders';

  // 多重送信フラグ（ふらぐ：送信中はtrueにして二重実行を防ぐ）
  let submitting = false;

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function postJsonWithTimeout(url, body, {timeoutMs=20000}={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(new Error('timeout')), timeoutMs);
    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(body),
        cache: 'no-store',
        keepalive: true,
        signal: ctrl.signal
      });
      const text = await res.text(); // 成功/失敗どちらでも本文を先に確保
      let data; try{ data = text ? JSON.parse(text) : null; }catch{ data = { raw:text }; }
      return { ok: res.ok, status: res.status, data };
    } finally {
      clearTimeout(t);
    }
  }

  function sanitize(str){ return String(str || '').replace(/\p{Cf}/gu,'').trim(); }

  var form = document.getElementById('contact-form');
  if (!form) return;

 form.addEventListener('submit', async function(e){
  e.preventDefault();

  // すでに送信中なら何もしない（連打防止）
  if (submitting) return;
  submitting = true;

  // 送信中のUI反映：ボタンと入力を一時無効化
  const submitBtn = document.getElementById('submitBtn');
  const restore = { text: submitBtn ? submitBtn.textContent : '' };
  if (submitBtn) {
    submitBtn.textContent = '送信中…';
    submitBtn.setAttribute('aria-busy', 'true');
    submitBtn.disabled = true;
  }
  // 入力要素を全て一時的に無効化（Enter送信やクリックを封じる）
  const disabledEls = [];
  form.querySelectorAll('input, textarea, button, select').forEach(el => {
    if (!el.disabled) { el.disabled = true; disabledEls.push(el); }
  });

  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (!cart.length) { alert('カートが空です。先に商品をお選びください。'); 
    // 復帰してから抜ける
    if (submitBtn) {
      submitBtn.textContent = restore.text;
      submitBtn.setAttribute('aria-busy', 'false');
      submitBtn.disabled = false;
    }
    disabledEls.forEach(el => el.disabled = false);
    submitting = false;
    return;
  }
    const fd = new FormData(e.target);
    // 文字列を念のため安全化（不可視制御文字などを除去）
    const customer = {
  lastName   : sanitize(fd.get('lastName')),
  firstName  : sanitize(fd.get('firstName')),
  lastKana   : sanitize(fd.get('lastKana')),
  firstKana  : sanitize(fd.get('firstKana')),
  zipcode    : sanitize(fd.get('zipcode')),
  prefecture : sanitize(fd.get('prefecture')),
  city       : sanitize(fd.get('city')),
  address    : sanitize(fd.get('address')),
  building   : sanitize(fd.get('building')),
  email      : sanitize(fd.get('email')),
  payment    : sanitize(fd.get('payment') || '銀行振込（PayPay銀行）'),
  // ★ サーバーが必要とする結合済みフィールドも明示で入れる
  name    : (sanitize(fd.get('lastName')) + ' ' + sanitize(fd.get('firstName'))).trim(),
  addressFull : (
    sanitize(fd.get('prefecture')) +
    sanitize(fd.get('city')) +
    sanitize(fd.get('address')) +
    sanitize(fd.get('building'))
  ).trim()
};

const items = cart.map(it => {
  const raw = it.productId ?? it.id ?? null;        // ここに slug が来てる
  const numericId = /^\d+$/.test(String(raw)) ? Number(raw) : null;

  return {
    productId   : numericId,                         // 数字じゃなければ null
    productName : sanitize(it.productName ?? it.variety ?? it.name ?? ''),
    unitPrice   : Number(it.price || 0),
    quantity    : Number(it.quantity || 1),

    // おまけ（追跡したいなら残す、要らなければ消してOK）
    productSlug : String(raw || ''),                 // "red-crystallinum" など
    image       : (it.image || '').split('?')[0].slice(0,512),
    category    : sanitize(it.category || ''),
    variety     : sanitize(it.variety || '')
  };
});

    const checkout = JSON.parse(localStorage.getItem('checkout') || 'null');
    const subtotal = items.reduce((s, it) => s + it.unitPrice * it.quantity, 0);
    const calcBaseShipping = n => (n >= 10000 ? 0 : n >= 5000 ? 350 : 700);
    const baseShipping  = (checkout && typeof checkout.baseShipping !== 'undefined') ? checkout.baseShipping : calcBaseShipping(subtotal);
    const addOpt        = (checkout && checkout.addOpt) || 0;
    const addOptText    = sanitize((checkout && checkout.addOptText) || '');
    const paymentMethod = (checkout && checkout.paymentMethod) || 'bank_transfer';
    const total         = (checkout && checkout.total) || (subtotal + baseShipping + addOpt);

    const payload = {
      customer,
      note: sanitize(fd.get('memo')),
      items,
      summary: {
        subtotal,
        shipping: baseShipping,
        shippingOptionAdd: addOpt,
        total,
        shippingOptionText: addOptText,
        paymentMethod
      }
    };

    try{
      // 1回目
      let r = await postJsonWithTimeout(API, payload, { timeoutMs: 20000 });

      // タイムアウト/502/504 は1回だけリトライ（短い待ち）
      if ((!r.ok && [502,504].includes(r.status)) || (r.data && r.data.code === 502)){
        await sleep(1200);
        r = await postJsonWithTimeout(API, payload, { timeoutMs: 20000 });
      }

      if (!r.ok){
        const msg = r.data?.message || r.data?.error || r.data?.raw || 'サーバーエラー';
        const reqId = r.data?.request_id ? `\nrequest_id: ${r.data.request_id}` : '';
        throw new Error(`HTTP ${r.status}: ${msg}${reqId}`);
      }

      const data = r.data || {};
      alert(`ありがとうございました。ご注文番号 #${data.orderToken || '-'}（合計 ¥${Number(data.total ?? total).toLocaleString()}）を受け付けました。`);

            localStorage.removeItem('cart');
      localStorage.removeItem('checkout');
      e.target.reset();

    }catch(err){
      alert(`エラー：${err.message}\n\n送信先: ${API}`);
      console.error('order error', err);
    } finally {
      // 送信中UIの復帰（成功・失敗どちらでも必ず実行）
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.textContent = '注文送信 >';
        submitBtn.setAttribute('aria-busy', 'false');
        submitBtn.disabled = false;
      }
      // 無効化していた入力を元に戻す
      form.querySelectorAll('input, textarea, button, select').forEach(el => { el.disabled = false; });
      submitting = false;
    }
  });
})();
</script>
</body>
</html>
