<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=950, user-scalable=no">
  <title>nursery sera - カート</title>
  <link href="https://fonts.googleapis.com/css2?family=Bayon&family=Tangerine:wght@700&family=Italianno&family=Noto+Serif+JP&display=swap" rel="stylesheet">
<style>
  html, body {
      margin: 0;
      padding: 0;
      font-size: 20px;
      -webkit-text-size-adjust: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      color: #333;
      box-sizing: border-box;
      scroll-behavior: smooth;
      height: 100%;
  }
  body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
  }
  *, *::before, *::after { box-sizing: inherit; }

  .header-bar {
      position: sticky;
      top: -50px;
      z-index: 1000;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      transition: top 0.5s ease;
  }
  .menu-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 48px;
      height: 40px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      transform: translateX(20px);
  }
  .menu-icon span {
      display: block;
      height: 3px;
      width: 100%;
      background-color: #333;
      border-radius: 2px;
  }
  .main-title {
      font-family: 'Bayon', cursive;
      font-size: 120px;
      margin: 0 ;
      left: 50%;
      white-space: nowrap;
      transform: translateX(20px);
  }
  .cart-button {
      background-image: url('https://gist.githubusercontent.com/nursery-sera/3bfad5863718f7147d193844bdaca462/raw/d7f9244ea2cbbaf4c13a67c30831022e37076b17/plantcart-icon.svg');
      background-size: contain;
      background-repeat: no-repeat;
      width: 100px;
      height: 100px;
      border: none;
      background-color: transparent;
      cursor: pointer;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.3);
    z-index: 2000;
    display: none;
  }
  .overlay.show { display: block; }

  .category-menu{
    position:fixed; top:0; left:0;
    width:55vw; height:100vh;
    background-color:rgba(255,255,255,.7);
    backdrop-filter:blur(8px);
    z-index:3000;
    border:2px solid rgba(0,0,0,.1);
    box-shadow:4px 0 20px rgba(0,0,0,.2);
    transform:translateX(-100%); opacity:0; pointer-events:none;
    transition:transform .4s ease, opacity .4s ease;
    padding:30px;
  }
  .category-menu.show{
    transform:translateX(0); opacity:1; pointer-events:auto;
  }

  .category-header{
    font-family:'Cinzel', serif;
    font-size:80px; margin-bottom:40px; letter-spacing:3px; color:#000;
    text-align:center;
  }
  .category-menu ul{ list-style:none; padding:0; margin:0; }
  .category-menu li{
    opacity: 0.8;
    font-family: 'Noto Serif JP', serif;
    font-size:36px; margin:20px 0; padding-bottom:10px; position:relative;
    border-bottom:1px solid rgba(0,0,0,.1);
    transition:transform .2s ease, color .2s ease;
    cursor:pointer; font-weight:400; color:#000!important; text-align:left; padding-right:20px;
  }
  .category-menu li:hover{ color:#c2185b; transform:scale(1.05); }
  .category-menu li::after{
    content:"＞"; position:absolute; right:0; top:2px; color:#bbb; font-size:20px;
  }

  .category-subtitle {
    font-size: 48px;
    font-family: 'Playfair Display SC', serif;
    margin: 66px 0 10px;
    color: #000000;
    font-weight: 400;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding-bottom: 4px;
    text-align:center;
  }
  .contact-links a {
    color: #000;
    text-decoration: none;
  }

  .subtitle1 {
      font-family: 'Tangerine', cursive;
      font-size: 80px;
      text-align: center;
      opacity: 0.7;
      margin-top: -30px;
      margin-bottom: 10px;
  }
  .subtitle2 {
      font-family: 'Cinzel', serif;
      font-size: 48px;
      text-align: center;
      margin: 60px 0 30px;
  }

  .cart-item {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin: 20px 0;
      padding-bottom: 20px;
  }
  .cart-item::after {
    content: "";
    display: block;
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 1px;
    background: #ccc;
  }

  /* 同じサイズのサムネ枠（正方形） */
  .cart-thumb{
    width: 35vw;
    max-width: none;
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    background: #f6f6f6;
    cursor: zoom-in;
  }
  .cart-thumb img{
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .item-info { flex: 1; }

  .item-price {
    transform: translate(0px, px);
    font-size: 28px;
    margin: 0px 0 0;
    opacity:0.9;
  }

  .quantity-control {
    font-size: 28px;
    display: flex;
    align-items: center;
    gap: 0px;
    margin: 10px 0 0;
    opacity:0.9;
  }
  .quantity-control button {
      font-size: 28px;
      border: none;
      background: none;
      color: #888;
      cursor: pointer;
  }
  .quantity-control input[type="number"] {
      width: 50px;
      text-align: center;
      font-size: 22px;
      border: 1px solid #ccc;
      border-radius: 0px;
      background: none;
      color:#888;
  }

  /* 削除ボタンを下線のすぐ上に固定配置 */
.remove-btn {
    position: absolute;
    right: 0; 
    bottom: 13px; 
    font-size: 25px;
    background: none;
    border: none;
    color: #000;
    cursor: pointer;
    text-decoration: underline;
}

  .container { flex: 1 0 auto; }
  .cart-area { padding: 0 5vw 40px; }

  .total {
      text-align: right;
      padding: 20px;
      font-size: 25px;
      font-weight: bold;
  }

  /* 合計エリアの行 */
  .sum-row{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:20px; font-size:25px; font-weight:normal; margin:22px 0;

  }
  .sum-row.total{ font-weight:bold; font-size:25px; }
  .sum-hr{ height:1px; background:#ccc; margin:14px 0; }

  .cart-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    padding: 0 20px 40px;
  }
  .cart-actions .order-btn,
  .cart-actions .back-btn {
    background: none;
    border: none;
    padding: 0;
    font-size: 48px;
    font-weight: 200;
    color: inherit;
    cursor: pointer;
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    padding-bottom: 6px;
    margin-top: 50px;
  }

  footer {
      margin-top: auto;
      padding: 30px 20px;
      background: #fff;
      text-align: center;
  }
  .footer-icons {
      display: flex;
      justify-content: center;
      gap: 60px;
      margin-bottom: 16px;
  }
  .footer-icons img {
      width: 48px;
      height: 48px;
  }
  .footer-links a {
      display: inline-block;
      margin: 0 20px;
      color: #444;
      font-size: 24px;
      text-decoration: none;
  }
  .footer-links a:hover { text-decoration: underline; }

  /* ---- 全体の文字色をグレー、タイトルだけ黒 ---- */
  body { color:#777; }
  .main-title { color:#000; }

  /* 既存で真っ黒固定にしてた要素は継承させる（グレーに統一） */
  .quantity-control button,
  .remove-btn,
  .category-menu li,
  .footer-links a { color: inherit; }

  /* オプション行：テキスト風セレクト＋矢印は文字 */
  .option-inline{ display:flex; align-items:center; gap:0; }
  .option-select{
    display:inline-block;
    width:auto;
    min-width:0;
    background:transparent;
    border:0;
    outline:0;
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    padding:0; margin-left:0; cursor:pointer;
    font-size:1em; line-height:1; color:inherit;
  }
  .option-select::-ms-expand{ display:none; }
  .option-caret{
    display:inline-block;
    font-size:1em;
    line-height:1;
    margin-left:0.25em;
    color:inherit;
  }
  .opt-measure{ position:absolute; visibility:hidden; white-space:nowrap; font-size:1em; }

  /* ====== ここから重複整理後 ====== */
  .item-info { min-width: 0; }

  /* 商品名ブロック：2行ぶんの固定枠を確保して、枠内の下端に揃える */
.item-name{
  font-family: 'Noto Serif JP', serif;
  font-size: 44px;
  color: #333;
  display: flex;            /* ← 追加：内側をフレックスにして */
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-end;/* ← 追加：下端に文字を寄せる（下に揃う） */
  width: 100%;
  position: relative;
  line-height: 1.1;
  min-width: 0;
  margin-top: 0;

  /* ★ここがポイント：最大フォント(44px)×行間(1.1)×2行 ≒ 96.8px を確保 */
  height: 98px;             /* ← 追加：固定の高さ（ズレ防止の“枠”） */
  overflow: hidden;         /* ← 追加：はみ出しガード */
padding-bottom: 10px;
}

/* 上に固定スペース（既存のまま） */
.item-name::before{
  content:"";
  display:block;
  height:0px;
}

/* 2段固定の内側ラッパー：文字はここで縮むだけ（枠の高さは不変） */
.name-shrink{
  display: flex;
  flex-direction: column;
  font-size: 44px;
  line-height: 1.1;
  width: 100%;              /* ← 追加：横幅を枠にフィット */
}

  /* カテゴリ名（1行固定） */
  .item-category{
    color:#555;
    margin-bottom:px;   /* 元コードを維持（値は無効だが見た目は不変） */
    opacity:0.9;
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    display: block;
  }

  /* バリエティ名（1行固定） */
  .item-variety{
    text-align:right;
    direction:ltr;
    margin-top:0px;   /* 最後の宣言を採用（-10px → 0px） */
    opacity:0.8;
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    display: block;
  }

.sum-row.total span:first-child{  /* 左側の「注文合計金額」ラベルだけ */
  transform: translateX(-20px);  /* ← 左へ10pxずらす */
}
.sum-row.total span:last-child{   /* 右側の合計金額だけ */
  transform: translateX(20px);   /* ← 右へ10pxずらす */
}

/* 未選択エラー時の軽い強調（きょうちょう） */
.option-select.invalid { border-bottom: 1px solid #c00; }


/* --- カルーセル用（横スライド＋ドット） --- */
/* スライダー本体（ほんたい） */
.thumb-slider{
  position: relative;
  width: 100%;
  height: 100%;           /* 親の .cart-thumb が正方形なので、その中で100%にフィット */
}

/* 横スクロールするトラック（なかみの横並びレーン） */
.thumb-track{
  display: flex;
  width: 100%;
  height: 100%;
  overflow-x: auto;                /* 指で左右（さゆう）にスクロール */
  scroll-snap-type: x mandatory;   /* スナップで1枚ずつ止まる */
  -webkit-overflow-scrolling: touch;
  gap: 0;
  /* スクロールバー非表示（ひひょうじ） */
  scrollbar-width: none;
}
.thumb-track::-webkit-scrollbar{ display: none; }

/* 1枚ぶんのスライド */
.thumb-slide{
  flex: 0 0 100%;                  /* 常に枠の幅ちょうど */
  height: 100%;
  scroll-snap-align: center;       /* 真ん中で止まる */
  position: relative;
  cursor: zoom-in;                 /* 既存の拡大モーダルに合わせる */
}
.thumb-slide img{
  width: 100%; height: 100%;
  object-fit: cover; display: block;
}

/* 下部（かぶ）に並ぶドット */
.thumb-dots{
  position: absolute;
  left: 0; right: 0; bottom: 8px;
  display: flex; justify-content: center; gap: 6px;
  pointer-events: auto;
}
/* --- ドットを正円に強制 --- */
.thumb-dot {
  width: 8px !important;
  height: 8px !important;
  border-radius: 50% !important;   /* 完全な円 */
  background: #ccc !important;
  opacity: .7 !important;
  border: none !important;
  box-shadow: none !important;

  padding: 0 !important;          /* 余白を消す */
  line-height: 0 !important;      /* テキスト高さを消す */
  display: inline-block !important; /* flexによる縦伸び防止 */
}

.thumb-dot.active {
  background: #333 !important;     /* 選択中だけ濃い */
  opacity: 1 !important;
}
</style>
</head>
<body>

  <? var url = getScriptUrl(); ?>
  <div class="header-bar" id="titleBar">
    <div class="menu-icon" onclick="toggleMenu(event)">
      <span></span><span></span><span></span>
    </div>
    <div class="main-title" onclick="window.top.location.href='<?= url ?>?page=index'">nursery sera</div>
    <button class="cart-button" onclick="window.top.location.href='<?= url ?>?page=cart'"></button>
  </div>

  <div class="category-menu" id="categoryMenu">
    <h1 class="category-header">MENU</h1>
<h2 class="category-subtitle">Category</h2>
    <ul>
      <li onclick="go('/?page=index')">All</li>
      <li onclick="go('/?page=index&liked=1')">like♡</li>
      <li onclick="go('/?page=index&cat=monstera')">Monstera</li>
      <li onclick="go('/?page=index&cat=alocasia')">Alocasia</li>
      <li onclick="go('/?page=index&cat=anthurium')">Anthurium</li>
      <li onclick="go('/?page=index&cat=philodendron')">Philodendron</li>
</ul>
<h2 class="category-subtitle">Contact</h2>
<ul class="contact-links">
  <li><a href="https://www.instagram.com/nursery_sera?igsh=cWx2cTZ3cWNicGlz&utm_source=" target="_blank">Instagram</a></li>
  <li><a href="https://lin.ee/mFSu5FS" target="_blank">LINE</a></li>
  <li><a href="https://www.threads.net/@nursery_sera?igshid=NTc4MTIwNjQ2YQ==" target="_blank">Threads</a></li>
  <li><a href="/?page=form">お問い合わせ</a></li>
</ul>
  </div>
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <p class="subtitle1">Order Summary</p>
  <p class="subtitle2"></p>

  <div class="container">
    <div class="cart-area">
      <div id="cartContainer"></div>

      <!-- 小計〜合計（オプション: プルダウン） -->
      <div id="totalPrice" class="total"></div>

      <div class="cart-actions">
        <button class="order-btn" onclick="goToOrder()">この内容で注文する ></button>
        <button class="back-btn" onclick="goToindex()">< 商品一覧に戻る</button>
      </div>
    </div>
  </div>

  <footer>
    
    <div class="footer-links">
      <a href="<?= url ?>?page=policy">各種ポリシー</a>
      <a href="<?= url ?>?page=policy">利用規約</a>
      <a href="<?= url ?>?page=policy">特定商取引法に基づく表記</a>
      <a href="<?= url ?>?page=policy">お問い合わせ</a>
    </div>
  </footer>

  <div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;" onclick="closeImageModal()">
    <img id="modalImage" src="" style="max-width:90vw; max-height:90vh; border:5px solid white; border-radius:10px;">
  </div>

  <script>

(function(){
  const MIN_PX = 14;  // 下限

  function fitRow(row){                 // row は .item-name
    if (!row) return;
    const target = row.querySelector('.name-shrink');
    if (!target) return;

    // 内側だけリセットしてから縮める
    target.style.fontSize = '';
    let size  = parseFloat(getComputedStyle(target).fontSize) || 44;
    let guard = 80;

    // "親の幅(row.clientWidth)" に収まるまで target を縮小
    while (target.scrollWidth > row.clientWidth && size > MIN_PX && guard-- > 0){
      size -= 1;
      target.style.fontSize = size + 'px';
    }
  }

  function fitCartNames(){
    document.querySelectorAll('.item-name').forEach(fitRow);
  }

  window.__fitCartNames = fitCartNames;
})();



  const BASE = window.location.origin;
  function go(path){ window.top.location.href = new URL(path, BASE).toString(); }

    function toggleMenu(event) {
      const menu = document.getElementById("categoryMenu");
      const overlay = document.getElementById("overlay");
      const isVisible = menu.classList.contains("show");
      if (!isVisible) {
        document.body.style.overflow = "hidden";
      } else {
        document.body.style.overflow = "";
      }
      menu.classList.toggle("show", !isVisible);
      overlay.classList.toggle("show", !isVisible);
    }
    function closeMenu() {
      document.getElementById("categoryMenu").classList.remove("show");
      document.getElementById("overlay").classList.remove("show");
      document.body.style.overflow = "";
    }

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const container = document.getElementById("cartContainer");
      const totalEl = document.getElementById("totalPrice");
      container.innerHTML = "";
      let subtotal = 0;

      if (cart.length === 0) {
        container.innerHTML = "<p style='text-align:center'>カートは空です。</p>";
        totalEl.innerHTML = "";
        return;
      }

     cart.forEach((item, i) => {
  const div = document.createElement("div");
  div.className = "cart-item";

  // ここで安全な値に丸める（NaN / undefined 対策。見た目は変えない）
  const imgSrc   = (item.image || "").trim();
  const category = (item.category || "").trim();
  const variety  = (item.variety  || item.name || "").trim();
  const unit     = Number(item.price || 0);
  const quantity = Number(item.quantity || 1);

  // 小計に加算（NaNを避ける）
  subtotal += (isFinite(unit) ? unit : 0) * (isFinite(quantity) ? quantity : 1);

   // 画像が複数ある場合はカルーセル（item.images が配列）。なければ単画像。
  const images = Array.isArray(item.images) && item.images.length
    ? item.images
    : (imgSrc ? [imgSrc] : []);

  let imgHTML = "";
  if (images.length === 0) {
    imgHTML = "";
  } else if (images.length === 1) {
    // 従来どおりの単画像（見た目とサイズは同じ）
    imgHTML = `
      <div class="cart-thumb" onclick="openImageModal('${images[0]}')">
        <img src="${images[0]}" alt="">
      </div>`;
  } else {
    // 複数画像 → カルーセル（横スライド＋ドット）
    const slides = images.map(u => `
      <div class="thumb-slide" onclick="openImageModal('${u}')">
        <img src="${u}" alt="">
      </div>`).join("");

    const dots = images.map((_,j) => `
      <button class="thumb-dot ${j===0?'active':''}" type="button"
              onclick="thumbGo(this, ${j})" aria-label="${j+1}枚目"></button>`).join("");

    imgHTML = `
      <div class="cart-thumb">
        <div class="thumb-slider">
          <div class="thumb-track" onscroll="onThumbScroll(this)">
            ${slides}
          </div>
          <div class="thumb-dots">
            ${dots}
          </div>
        </div>
      </div>`;
  }

  div.innerHTML = `
    ${imgHTML}
    <div class="item-info">
      <p class="item-name">
  <span class="name-shrink">
    <span class="item-category">${category}</span>
    <span class="item-variety">${variety}</span>
  </span>
</p>
      <p class="item-price">価格　：　¥${(unit * quantity).toLocaleString()}（税込）</p>
      <div class="quantity-control">
        <span class="quantity-label">数量　：</span>
        <button onclick="changeQuantity(${i}, -1)">−</button>
        <input type="number" min="1" value="${isFinite(quantity) ? quantity : 1}" onchange="updateQuantity(${i}, this.value)">
        <button onclick="changeQuantity(${i}, 1)">＋</button>
      </div>
      <button class="remove-btn" onclick="removeItem(${i})">✖削除</button>
    </div>
  `;
  container.appendChild(div);
});

      // サマリー（プルダウン式オプション・送料行・案内文）
      totalEl.innerHTML = `
        <div class="sum-row"><span>小計</span><span id="sum-subtotal">¥0</span></div>

    

<div class="sum-row" style="align-items:center;">
  <div class="option-inline" style="white-space:nowrap; position:relative;">
    <label>配送方法</label>
    <span id="opt-measure" class="opt-measure"></span>
    <select id="opt-select" class="option-select">
      <!-- 選択肢は JS が数量・小計に応じて動的生成（どうてき せいせい：自動で作る） -->
      <option value="">を選択</option>
    </select>
    <span class="option-caret" aria-hidden="true">∨</span>
  </div>
  <!-- 右側に「送料¥〇〇」を表示 -->
  <span id="sum-shipping" style="min-width:8em; text-align:right;">¥0</span>
</div>

<div class="sum-hr"></div>

<div class="sum-row total">
  <span>注文合計金額</span>
  <span id="sum-total">¥0</span>
</div>

<div style="text-align:left; font-size:20px; line-height:1.7; font-weight:200; margin-top:14px;">


<div>・通常時：速達550円／特定記録(追跡番号付き)770円／ヤマト運輸1100円</div>
<div>・数量3株以上：速達無料／特定記録(追跡番号付き)220円／ヤマト運輸550円</div>
<div>・数量5株以上：速達無料／特定記録(追跡番号付き)無料／ヤマト運輸330円</div>
 <div>・北海道・沖縄・離島の方は第四種郵便のみになります。</div>
<div>・発送は〇〇月〇〇頃を予定しております。</div>
<div>・組織培養株のため、ご購入後に順化作業が必要となります。</div>
<div>・輸入後に品質確認を行い、品質が悪い場合や植物に痛みが確認された場合には</div>
<div style="padding-left:1em;">迅速に返金対応をさせていただきます。なお、輸入の特性上、株を選んでお届けすることはできず発送する株はランダムとなりますので、あらかじめご了承ください。</div>

</div>

      `;

      // 初期反映（しょきはんえい：最初の表示に数値を反映）
      updateSummaryNumbers(subtotal);
      sizeOption(); // 選択中のテキスト幅に合わせてセレクトを縮める

      // 変更イベント（へんこういべんと：プルダウン変更時に再計算＋再フィット）
      const sel = document.getElementById('opt-select');
sel && sel.addEventListener('change', () => {
  sel.classList.remove('invalid');             // ★未選択エラー見た目を解除
  sizeOption();
  updateSummaryNumbers(subtotal);
  requestAnimationFrame(() => window.__fitCartNames?.());
});

      // 描画が終わったフレームで1回だけフィット（はみ出す前に調整）
      requestAnimationFrame(() => window.__fitCartNames?.());

      // 画面サイズ変更（resize：りさいず）でも再フィット ※初回だけバインド（ばいんど：1回だけ登録）
      if (!window.__cartFitBound){
        window.addEventListener('resize', () => window.__fitCartNames?.(), { passive:true });
        window.__cartFitBound = true;
      }
 initAllThumbs();

    }

    // 送料の基本計算（小計で変化）
// ★配送金額テーブル（てーぶる：表）を返す
function calcShippingOptions(subtotal, totalQty){
  // 10株以上 or 3万円以上 → 全部0円
  if (totalQty >= 8 || subtotal >= 25000){
    return {
      "第四種郵便速達": 0,
      "第四種速達＋特定記録": 0,
      "ヤマト運輸": 0
    };
  }
  // 5株以上
  if (totalQty >= 5){
    return {
      "第四種郵便速達": 0,
      "第四種郵便速達＋特定記録": 0,
      "ヤマト運輸": 330
    };
  }
  // 3株以上
  if (totalQty >= 3){
    return {
      "第四種郵便速達": 0,
      "第四種郵便速達＋特定記録": 220,
      "ヤマト運輸": 550
    };
  }
  // 通常
  return {
    "第四種郵便速達": 550,
    "第四種郵便速達＋特定記録": 770,
    "ヤマト運輸": 1100
  };
}
    function yen(n){ return '¥' + Number(n||0).toLocaleString(); }

function updateSummaryNumbers(subtotal){
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const totalQty = cart.reduce((s,it)=> s + Number(it.quantity||0), 0);

  // 条件ごとの送料一覧（いちらん）を取得
  const options = calcShippingOptions(subtotal, totalQty);
  const sel = document.getElementById('opt-select');

  // プルダウンを毎回作り直し（在庫や数量の変化に追随）
  if (sel){
    const currentName = sel.value || "";
    sel.innerHTML = '<option value="">を選択</option>';
    Object.entries(options).forEach(([name,cost])=>{
      const opt = document.createElement('option');
      opt.value = name;                     // ← DB保存は「名前」
      opt.dataset.cost = String(cost);      // ← 表示計算用に金額を持たせる
      opt.textContent = `${name}　送料¥${cost.toLocaleString()}`;
      sel.appendChild(opt);
    });
    // 直前の選択を可能なら維持
    if (currentName){
      const found = Array.from(sel.options).find(o=>o.value===currentName);
      if (found) sel.value = currentName;
    }
  }

  // 選択値の取得
  const selected = sel ? sel.options[sel.selectedIndex] : null;
  const shippingCost = selected ? Number(selected.dataset.cost||0) : 0;

  // 数字を反映
  const sumSubtotal = document.getElementById('sum-subtotal');
  const sumShipping = document.getElementById('sum-shipping');
  const sumTotal    = document.getElementById('sum-total');

  if(sumSubtotal) sumSubtotal.textContent = yen(subtotal);
  if(sumShipping) sumShipping.textContent = yen(shippingCost);
  if(sumTotal)    sumTotal.textContent    = yen(subtotal + shippingCost);
}

    // 選択中テキスト幅に応じて select を縮め、直後の「∨」を常に真横に配置
    function sizeOption(){
      const sel = document.getElementById('opt-select');
      const meter = document.getElementById('opt-measure');
      if(!sel || !meter) return;
      const cs = getComputedStyle(sel);
      meter.style.font = cs.font;
      meter.textContent = sel.options[sel.selectedIndex].text;
      sel.style.width = (meter.offsetWidth + 2) + 'px';
    }

    function changeQuantity(index, delta) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart[index].quantity = (cart[index].quantity || 1) + delta;
      if (cart[index].quantity < 1) cart[index].quantity = 1;
      localStorage.setItem('cart', JSON.stringify(cart));
      loadCart();
    }

    function updateQuantity(index, value) {
      const qty = parseInt(value);
      if (isNaN(qty) || qty < 1) return;
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart[index].quantity = qty;
      localStorage.setItem('cart', JSON.stringify(cart));
      loadCart();
    }

    function removeItem(index) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      loadCart();
    }
    
    // 小計だけ計算（subtotalだけ使い回したいとき用）
function getCartSubtotal(){
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  return cart.reduce((s, it) => s + Number(it.price || 0) * Number(it.quantity || 1), 0);
}

    // 注文ボタン：遷移直前に「合計情報のスナップショット」を保存してから order へ
function goToOrder() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart.length === 0) {
    alert("カートが空です");
    return;
  }
  const normalized = cart.map(it => ({
    ...it,
    productId: it.productId ?? it.id ?? null,
    productName: it.productName ?? it.variety ?? it.name ?? ''
  }));
  localStorage.setItem('cart', JSON.stringify(normalized));

  const subtotal = cart.reduce((s, it) => s + Number(it.price || 0) * Number(it.quantity || 1), 0);
  const sel = document.getElementById('opt-select');
  const selected = sel ? sel.options[sel.selectedIndex] : null;

  // ★必須チェック（ひっすちぇっく）：未選択なら止める
  if (!sel || !sel.value) {
    sel?.classList.add('invalid');                         // 見た目で分かるようにする
    alert("配送方法を選択してください");
    try {
      sel?.focus();
      sel?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } catch(e) {}
    return;                                                // ここで終了（進ませない）
  }

  const shippingName = selected ? selected.value : "";
  const shippingCost = selected ? Number(selected.dataset.cost || 0) : 0;

  const total = subtotal + shippingCost;

  const checkout = {
    subtotal,
    shippingCost,
    total,
    shippingName,
    paymentMethod: 'bank_transfer'
  };
  localStorage.setItem('checkout', JSON.stringify(checkout));
  window.top.location.href = '<?= url ?>?page=order';
}
    function goToindex() {
      window.top.location.href = '<?= url ?>?page=index';
    }

    function openImageModal(url) {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = url;
      modal.style.display = "flex";
    }

    function closeImageModal() {
      document.getElementById("imageModal").style.display = "none";
    }

    window.onload = loadCart;

    let lastScrollY = window.scrollY;
    const titleBar = document.getElementById("titleBar");
    const threshold = 10;

    window.addEventListener("scroll", () => {
      const currentScrollY = window.scrollY;
      const diff = currentScrollY - lastScrollY;
      if (Math.abs(diff) < threshold) return;
      titleBar.style.top = diff < 0 ? "-50px" : "-200px";
      lastScrollY = currentScrollY;
    });

// --- カルーセル制御（せいぎょ） ---
function thumbGo(dotBtn, slideIndex){
  const slider = dotBtn.closest('.thumb-slider');
  if (!slider) return;
  const track = slider.querySelector('.thumb-track');
  if (!track) return;
  track.scrollTo({ left: track.clientWidth * slideIndex, behavior: 'smooth' });

  // ドットのアクティブ更新
  const dots = slider.querySelectorAll('.thumb-dot');
  dots.forEach((d,k)=> d.classList.toggle('active', k===slideIndex));
}

function onThumbScroll(track){
  // いま見えているスライド番号を丸めて算出
  const idx = Math.round(track.scrollLeft / Math.max(1, track.clientWidth));
  const slider = track.closest('.thumb-slider');
  if (!slider) return;
  const dots = slider.querySelectorAll('.thumb-dot');
  dots.forEach((d,k)=> d.classList.toggle('active', k===idx));
}

// 初期（しょき）に一度だけ、表示状態に合わせてドットを整える
function initAllThumbs(){
  document.querySelectorAll('.thumb-slider').forEach(slider=>{
    const track = slider.querySelector('.thumb-track');
    if (!track) return;
    onThumbScroll(track);
  });
}
  </script>
</body>
</html>
