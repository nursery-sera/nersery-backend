<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - nursery sera</title>
  <style>
    :root{
      --pink:#f8c6dc;
      --gray:#666;
      --shadow:0 10px 24px rgba(0,0,0,.12);
    }
    html,body{margin:0;padding:0;font-family:Arial, sans-serif;background:#fff;color:#333}
    .wrap{max-width:960px;margin:0 auto;padding:24px 16px}
    h1{font-size:28px;margin:0 0 12px}
    p.help{margin:0 0 18px;color:#666}

    /* FAB */
    .fab{
      position:fixed;right:20px;bottom:20px;z-index:10;
      width:64px;height:64px;border-radius:50%;
      border:0;background:var(--pink);box-shadow:var(--shadow);
      font-size:40px;line-height:64px;text-align:center;cursor:pointer;
    }

    /* パネル */
    .panel{
      position:fixed;left:0;right:0;bottom:0;transform:translateY(105%);
      background:#fff;border-radius:24px 24px 0 0;box-shadow:var(--shadow);
      padding:18px 16px 24px;transition:transform .3s ease;z-index:20;
      max-width:960px;margin:0 auto;
    }
    .panel.show{ transform:translateY(0); }
    .panel h2{margin:4px 0 12px;font-size:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .row label{display:block;font-size:14px;color:#555;margin-bottom:6px}
    .col{flex:1 1 260px;min-width:240px}
    input[type="text"],input[type="number"]{
      width:100%;height:44px;border:1px solid #ddd;border-radius:10px;padding:0 12px;font-size:16px;
    }
    input[type="file"]{width:100%;}

    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .btn{
      min-width:130px;height:44px;border-radius:10px;border:0;cursor:pointer;
      padding:0 16px;font-size:16px;
    }
    .btn.primary{background:var(--pink)}
    .btn.ghost{background:#fff;border:1px solid #ddd}
    .btn.danger{background:#c2185b;color:#fff}

    .card{
      border:1px solid #eee;border-radius:14px;padding:14px;margin:14px 0;
    }
    .muted{color:#777;font-size:14px}
    .ok{color:#0b8f00}
    .err{color:#c2185b}

    progress{width:100%;height:10px;margin-top:6px}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #eee}

    .topbar{
      position:sticky;top:0;background:#fff;padding:12px 16px;border-bottom:1px solid #eee;z-index:5
    }
    .topbar a{color:#333;text-decoration:none}
    .foot{padding:24px 16px 60px;color:#777;text-align:center}

    /* 一覧 */
    #list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .item{
      border:1px solid #eee;border-radius:12px;overflow:hidden;display:flex;flex-direction:column
    }
    .item .imgs{display:flex;gap:6px;padding:10px;flex-wrap:wrap;background:#fafafa}
    .item .imgs img{width:70px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #eee}
    .item .body{padding:12px}
    .item .title{font-weight:bold}
    .item .sub{color:#777;font-size:14px;margin-top:3px}
    .item .ops{display:flex;gap:8px;margin-top:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <a href="/">← サイトへ戻る</a>
    </div>
  </div>

  <div class="wrap">
    <h1>Admin（商品追加 / 削除）</h1>
    <p class="help">
      右下の「＋」ボタン → 入力して「保存」で <code>products</code> に追加。<br>
      下の一覧から「削除」もできます（画像も一緒に削除）。
    </p>

    <div id="lastResult" class="card muted">まだ作成していません。</div>

    <div class="card">
      <div><b>現在の設定</b></div>
      <div class="muted" id="cfgView"></div>
    </div>

    <h2 style="margin-top:24px">現在の商品一覧</h2>
    <div id="list"></div>
  </div>

  <!-- 入力パネル -->
  <div id="panel" class="panel" aria-hidden="true">
    <h2>商品を追加</h2>

    <div class="row">
      <div class="col">
        <label>商品画像（0〜2枚 / スマホOK）</label>
        <!-- captureを付けない＝カメラロールから選べる -->
        <input id="images" type="file" accept="image/*" multiple />
        <div class="muted">2枚まで。順番＝スワイプ順。カメラロールから選べます。</div>
        <div id="thumbs" class="thumbs"></div>
        <div id="progWrap" style="display:none">
          <div class="muted">アップロード中…</div>
          <progress id="prog" max="100" value="0"></progress>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>カテゴリーネーム（例: Alocasia）</label>
        <input id="categoryName" type="text" placeholder="Alocasia" />
      </div>
      <div class="col">
        <label>バラエティーネーム（例: Silver Dragon Variegata）</label>
        <input id="varietyName" type="text" placeholder="Silver Dragon Variegata" />
      </div>
      <div class="col">
        <label>金額（半角数字）</label>
        <input id="price" type="number" inputmode="numeric" placeholder="3500" />
      </div>
    </div>

    <!-- ★追加：作成数プルダウン（ここだけUI追加） -->
    <div class="row">
      <div class="col">
        <label>作成数</label>
        <select id="createCount">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
        <div class="muted">同じ内容で複数のドキュメントを一括作成します。</div>
      </div>
    </div>
    <!-- ★追加ここまで -->

    <div class="actions">
      <button id="cancelBtn" class="btn ghost">キャンセル</button>
      <button id="saveBtn" class="btn primary">保存</button>
    </div>
  </div>

  <!-- 右下の＋ -->
  <button id="fab" class="fab" aria-label="add">＋</button>

  <div class="foot">※コンニチワ！バブルスデス！。</div>

  <!-- Firebase SDK（モジュール） -->
  <script type="module">
    // ====== 超かんたんパスワードガード ======
    (function(){
      const pass = sessionStorage.getItem('admin-pass') || prompt('パスワードを入力してくり〜');
      if (pass !== 'kusakuri') {
        alert('ばか');
        location.href = '/';
      } else {
        sessionStorage.setItem('admin-pass', pass);
      }
    })();

    // ====== Firebase 初期化 ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, serverTimestamp,
      collection, getDocs, query, orderBy, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, listAll
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVOfVGTlfTGRfpNggT55l3raCqjo7OcBo",
      authDomain: "nursery-9bd14.firebaseapp.com",
      projectId: "nursery-9bd14",
      storageBucket: "nursery-9bd14.firebasestorage.app",
      messagingSenderId: "123851517861",
      appId: "1:123851517861:web:42afa474c5b6d62669024c",
      measurementId: "G-J2S4HRGG45"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const st  = getStorage(app);

    // 画面に設定を軽く表示
    document.getElementById('cfgView').textContent =
      `projectId=${firebaseConfig.projectId}, storageBucket=${firebaseConfig.storageBucket}`;

    // ====== UI 参照 ======
    const fab       = document.getElementById('fab');
    const panel     = document.getElementById('panel');
    const imagesEl  = document.getElementById('images');
    const thumbsEl  = document.getElementById('thumbs');
    const progWrap  = document.getElementById('progWrap');
    const prog      = document.getElementById('prog');
    const categoryEl= document.getElementById('categoryName');
    const varietyEl = document.getElementById('varietyName');
    const priceEl   = document.getElementById('price');
    const saveBtn   = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const lastRes   = document.getElementById('lastResult');
    const listEl    = document.getElementById('list');
    const createCountEl = document.getElementById('createCount'); // ★追加：参照1行だけ

    // ====== パネル開閉 ======
    const openPanel  = ()=>{ panel.classList.add('show'); panel.setAttribute('aria-hidden','false'); };
    const closePanel = ()=>{ panel.classList.remove('show'); panel.setAttribute('aria-hidden','true'); };

    fab.addEventListener('click', openPanel);
    cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closePanel(); });

    // プレビュー
    imagesEl.addEventListener('change', ()=>{
      thumbsEl.innerHTML = '';
      const files = [...(imagesEl.files || [])].slice(0, 2);
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        thumbsEl.appendChild(img);
      });
    });

    // ====== 保存ロジック（選んだ作成数ぶん連続作成 / 画像も各IDごとに保存） ======
    async function saveProduct(){
      try{
        const categoryName = (categoryEl.value || '').trim();
        const varietyName  = (varietyEl.value  || '').trim();
        const priceNum     = Number((priceEl.value || '').trim());
        const makeCount    = Math.max(1, Number(createCountEl?.value || 1)); // ★追加：作成数

        if (!categoryName){ alert('カテゴリーネームを入力してください'); return; }
        if (!varietyName){ alert('バラエティーネームを入力してください'); return; }
        if (!Number.isFinite(priceNum) || priceNum < 0){ alert('金額は0以上の数字で入力してください'); return; }

        // 選択された画像（0〜2枚）
        const pickedFiles = [...(imagesEl.files || [])].slice(0, 2);

        // 進捗UI
        progWrap.style.display = pickedFiles.length ? 'block' : 'none';
        prog.value = 0;

        const createdIds = [];

        // ===== N 回作成 =====
        for (let n = 0; n < makeCount; n++){
          // doc id 先取り（Storageフォルダにも使う）
          const newRef = doc(collection(db, 'products'));
          const newId  = newRef.id;

          // 画像アップロード（このID専用フォルダへ）※削除機能と整合
          const urls = [];
          for (let i = 0; i < pickedFiles.length; i++){
            const f = pickedFiles[i];

            // 圧縮（最長辺1200px / 品質0.78）
            const { blob, mime, name } = await compressImage(f, 1200, 0.78);

            const path = `products/${newId}/${Date.now()}_${i}_${sanitizeName(name)}`;
            const storageRef = ref(st, path);
            const metadata = { contentType: mime };
            const task = uploadBytesResumable(storageRef, blob, metadata);

            // 進捗：全体（ファイル数×作成数）でざっくり
            const totalFiles = Math.max(1, pickedFiles.length * makeCount);
            const baseIndex  = n * pickedFiles.length + i;

            const url = await new Promise((resolve, reject)=>{
              task.on('state_changed', s=>{
                const pct = Math.round((s.bytesTransferred / s.totalBytes) * 100);
                const perFile = 100 / totalFiles;
                prog.value = Math.min(100, Math.round(perFile * baseIndex + (pct * perFile / 100)));
              }, reject, async ()=>{
                const u = await getDownloadURL(task.snapshot.ref);
                resolve(u);
              });
            });
            urls.push(url);
          }

          // Firestore に保存
          const data = {
            categoryName,
            varietyName,
            price: priceNum,
            images: urls,             // 配列（0〜2 個）
            createdAt: serverTimestamp()
          };
          await setDoc(newRef, data);
          createdIds.push(newId);
        }

        // 完了表示（作成したID一覧）
        lastRes.innerHTML = `
          <div class="ok"><b>保存に成功しました（${makeCount}件）。</b></div>
          <div class="muted">ドキュメントID：</div>
          <div class="muted" style="max-height:140px;overflow:auto">
            ${createdIds.map(id=>`<div><code>${id}</code></div>`).join('')}
          </div>
          <div class="muted">画像：${(imagesEl.files && imagesEl.files.length) ? imagesEl.files.length + '枚/各商品' : '（なし）'}</div>
          <div style="margin-top:8px"><a href="/" target="_blank">サイトで確認（index）</a></div>
        `;

        // フォームリセット
        categoryEl.value = '';
        varietyEl.value  = '';
        priceEl.value    = '';
        if (createCountEl) createCountEl.value = '1';
        imagesEl.value   = '';
        thumbsEl.innerHTML = '';
        progWrap.style.display = 'none';
        prog.value = 0;

        // パネル閉じる
        closePanel();

        // 一覧を更新
        await loadList();

      }catch(err){
        console.error(err);
        alert('保存中にエラーが発生しました');
        lastRes.innerHTML = `<div class="err"><b>エラー：</b> ${String((err && err.message) || err)}</div>`;
        progWrap.style.display = 'none';
      }
    }

    // ===== 画像を圧縮&リサイズ（最長辺 maxSize, JPEG品質 quality） =====
    async function compressImage(file, maxSize = 1200, quality = 0.78) {
      // createImageBitmap 優先（速い）。ダメなら <img> でフォールバック
      const bitmap = await createImageBitmap(file).catch(async () => {
        const url = URL.createObjectURL(file);
        const img = await new Promise((res, rej) => {
          const im = new Image();
          im.onload = () => res(im);
          im.onerror = rej;
          im.src = url;
        });
        URL.revokeObjectURL(url);
        return img;
      });

      const w = bitmap.width, h = bitmap.height;
      let targetW = w, targetH = h;
      if (Math.max(w, h) > maxSize) {
        if (w >= h) {
          targetW = maxSize;
          targetH = Math.round(h * (maxSize / w));
        } else {
          targetH = maxSize;
          targetW = Math.round(w * (maxSize / h));
        }
      }

      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, targetW, targetH);

      // HEIC 等も JPEG へ統一（軽量化）
      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), 'image/jpeg', quality);
      });

      // 元ファイル名を .jpg で返す
      const safeName = (file.name || 'image').replace(/\.[^.]+$/, '') + '.jpg';
      return { blob, mime: 'image/jpeg', name: safeName };
    }

    function sanitizeName(name){
      return name.replace(/[^\w.\-]+/g,'_');
    }

    saveBtn.addEventListener('click', (e)=>{ e.preventDefault(); saveProduct(); });

    // ====== 一覧の取得＆表示 ======
    async function loadList(){
      listEl.innerHTML = '<div class="muted">読み込み中…</div>';
      try{
        let docs = [];
        try{
          const q = query(collection(db,'products'), orderBy('createdAt','desc'));
          const snap = await getDocs(q);
          docs = snap.docs;
        }catch{
          const snap = await getDocs(collection(db,'products'));
          docs = snap.docs;
        }

        if (!docs.length){
          listEl.innerHTML = '<div class="muted">商品はまだありません。</div>';
          return;
        }

        listEl.innerHTML = '';
        docs.forEach(d=>{
          const data = d.data();
          const id   = d.id;
          const imgs = Array.isArray(data.images) ? data.images : [];
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="imgs">
              ${imgs.length ? imgs.map(u=>`<img src="${u}" alt="">`).join('') : '<span class="muted">（画像なし）</span>'}
            </div>
            <div class="body">
              <div class="title">${escapeHtml(data.categoryName || '')}</div>
              <div class="sub">${escapeHtml(data.varietyName || '')}</div>
              <div class="sub">¥ ${Number(data.price||0).toLocaleString()}</div>
              <div class="sub muted">ID: <code>${id}</code></div>
              <div class="ops">
                <button class="btn danger" data-del="${id}">削除</button>
              </div>
            </div>
          `;
          listEl.appendChild(el);
        });

        // 削除ボタンにイベント付与
        listEl.querySelectorAll('[data-del]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.getAttribute('data-del');
            if (!confirm('この商品を削除しますか？（画像も削除）')) return;
            await deleteProduct(id);
            await loadList();
          });
        });

      }catch(err){
        console.error(err);
        listEl.innerHTML = `<div class="err">読み込みエラー：${String(err && err.message || err)}</div>`;
      }
    }

    // ====== 商品削除（画像も） ======
    async function deleteProduct(id){
      try{
        // 1) Storage: products/{id}/ 以下を列挙して全部 delete
        const folderRef = ref(st, `products/${id}`);
        try{
          const res = await listAll(folderRef);
          // ファイル
          for (const itemRef of res.items){
            await deleteObject(itemRef);
          }
          // サブフォルダ（通常ない想定だけど念のため）
          for (const dirRef of res.prefixes){
            const sub = await listAll(dirRef);
            for (const itemRef of sub.items){
              await deleteObject(itemRef);
            }
          }
        }catch(storageErr){
          // 画像が無いなどは無視してOK
          console.warn('storage delete warn:', storageErr?.message || storageErr);
        }

        // 2) Firestore ドキュメントを削除
        await deleteDoc(doc(collection(db,'products'), id));
        lastRes.innerHTML = `<div class="ok"><b>削除しました：</b> ${id}</div>`;
      }catch(err){
        console.error(err);
        alert('削除に失敗しました');
        lastRes.innerHTML = `<div class="err"><b>削除エラー：</b> ${String(err && err.message || err)}</div>`;
      }
    }

    // HTMLエスケープ
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // 初回ロード
    loadList();
  </script>

  <!-- 参考：Firestore/Storage ルール（コンソールで設定してください）
    Firestore（例：誰でも読み取りOK、書き込みは認証/制限したい時はここを強化）
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /products/{id} {
          allow read: if true;
          allow write: if false; // 本番はadminのみ許可にすること（今回は簡易パスのためfalse推奨）
        }
      }
    }

    Storage（例：画像は公開読み取りOK、書き込みは禁止/本番はadminのみ）
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /{allPaths=**} {
          allow read: if true;
          allow write: if false;
        }
      }
    }
  -->
</body>
</html>