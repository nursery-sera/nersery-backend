<!DOCTYPE html>
<html lang="ja">
<head>
  
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=950, user-scalable=no">
  <title>nursery sera - 商品一覧</title>

  <!-- preconnect（ぷりこねくと：先につないで待ち時間短縮） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://firestore.googleapis.com">
  <link rel="preconnect" href="https://firebasestorage.googleapis.com">
  <link rel="preconnect" href="https://gist.githubusercontent.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Bayon&family=Tangerine:wght@700&family=Italianno&family=Noto+Serif+JP&display=swap" rel="stylesheet">

  <style>
    /* ===== ベース ===== */
    html,body{
      margin:0;padding:0;font-size:20px;-webkit-text-size-adjust:100%;
      font-family:Arial,sans-serif;background:#fff;color:#333;box-sizing:border-box
    }
    *,*:before,*:after{box-sizing:inherit}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}

    /* ▼ 追加：縦フレックスで“底に吸いつく” */
    html, body { height:100%; }
    body { min-height:100vh; display:flex; flex-direction:column; }
    main { flex:1 0 auto; }           /* 本文が余り高さを受け持つ */
    
    /* ===== ヘッダー ===== */
    .header-bar{
  position:fixed; top:0; left:0; right:0; width:100%; /* 画面に張り付け（ふぃっくすど） */
  margin-top:-50px; z-index:1000;
  background:transparent;
  display:flex; align-items:center; justify-content:space-between;
  padding:20px; transition:transform .5s ease;
border:none; 
  box-shadow:none;
opacity:1;
  transition: opacity 0.2s ease;   /* 0.6秒かけてなめらかに変化 */
  will-change: opacity;    
}

.header-bar.is-hidden{
  opacity: 0;
  pointer-events: none;
}
    .menu-icon{
      display:flex; flex-direction:column; justify-content:space-between;
      width:48px; height:40px; cursor:pointer; background:none; border:none;
      padding:0; margin:0; transform:translateX(20px);
    }
    .menu-icon span{
      display:block; height:3px; width:100%; background:#333; border-radius:2px;
    }
    .main-title{
      font-family:'Bayon', cursive;
      font-size:109px; margin:0; white-space:nowrap; transform:translateX(20px);
      cursor:pointer;
opacity:1;color:#333
    }
    .cart-button{
      background-image:url('https://gist.githubusercontent.com/nursery-sera/3bfad5863718f7147d193844bdaca462/raw/d7f9244ea2cbbaf4c13a67c30831022e37076b17/plantcart-icon.svg');
      background-size:contain; background-repeat:no-repeat;
      width:100px; height:100px; border:none; background-color:transparent; cursor:pointer;
position:relative;
    }

.cart-badge{
  position:absolute; right:15px; top:47px;font-weight: 700;
  min-width:50px; height:50px; padding:0 6px;
  border-radius:25px;
  background:#FF4F9A; color:#fff; 
  font-size:24px; line-height:28px; text-align:center;
  display:none;           /* 0個のときは非表示 */
  align-items:center;     /* 将来flexにしても中央寄せされるように保険 */
  justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

    /* ===== メニュー（スライド＋オーバーレイ） ===== */
    .overlay{
      position:fixed; inset:0;             /* ← 100vw/100vh をやめてはみ出し防止 */
      background:rgba(0,0,0,.3); z-index:2000; display:none;
    }
    .overlay.show{ display:block; }

    .category-menu{
      position:fixed; top:0; left:0;
      width:55vw; height:100vh;
      background-color:rgba(255,255,255,.7);
      /* backdrop-filter は閉じている間は無効（負荷削減） */
      z-index:3000;
      border:2px solid rgba(0,0,0,.1);
      box-shadow:4px 0 20px rgba(0,0,0,.2);
      transform:translateX(-100%); opacity:0; pointer-events:none;
      transition:transform .4s ease, opacity .4s ease;
      padding:30px;
    }
    .category-menu.show{
      transform:translateX(0); opacity:1; pointer-events:auto;
      /* 開いている時だけ背景ぼかし（見た目同じ） */
      backdrop-filter:blur(8px);
    }

    .category-header{
      font-family:'Cinzel', serif;
      font-size:80px; margin-bottom:40px; letter-spacing:3px; color:#000;
      text-align:center;
    }
    .category-menu ul{ list-style:none; padding:0; margin:0; }
    .category-menu li{opacity: 0.8;
font-family: 'Noto Serif JP', serif;
      font-size:36px; margin:20px 0; padding-bottom:10px; position:relative;
      border-bottom:1px solid rgba(0,0,0,.1);
      transition:transform .2s ease, color .2s ease;
      cursor:pointer; font-weight:400; color:#000; text-align:left; padding-right:20px;
    }
    .category-menu li:hover{ color:#c2185b; transform:scale(1.05); }
    .category-menu li::after{
      content:"＞"; position:absolute; right:0; top:2px; color:#bbb; font-size:20px;
    }

    /* ===== フッター ===== */
    footer{
      margin-top:auto; /* ← Flex で“底に吸いつく”（見た目のデザインは変わりません） */
      padding:30px 20px; background:#fff; text-align:center;
    }
    .footer-icons{
      display:flex; justify-content:center; gap:60px; margin-bottom:16px;
    }
    .footer-icons img{ width:42px; height:42px; }
    .footer-links a{
      display:inline-block; margin:0 20px; color:#444; font-size:24px; text-decoration:none;
    }
    .footer-links a:hover{ text-decoration:underline; }

    .subtitle1 {
      font-family: 'Tangerine', cursive;
      font-size: 100px;
      text-align: center;
      opacity: 0.4;
      margin-top:160px;
      margin-bottom: 10px;
    }

    /* ===== 上部フィルタ & カテゴリ ===== */
    .top-row .categories{
      display:flex;
      gap:20px;
      padding:18px 0 36px;
      overflow-x:auto;
      white-space:nowrap;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      flex-wrap:nowrap;
      margin-top: 50px;
    }
    .top-row .categories::-webkit-scrollbar{ display:none; }
    .top-row .categories button{ font-family: 'Lustria;
      flex:0 0 auto;
      font-size:38px;
      padding:15px 80px;
      background:#F8C6DC;
      border:px solid #999;
      border-radius:60px;
      font-weight:500;
      color:#fff;
opacity:;
      box-shadow:1px 1px 6px rgba(0,0,0,.1);
    }

    /* ===== 商品カード ===== */
    .product-item{display:flex;margin-left:20px;gap:48px;align-items:flex-start;padding:20px 10px;border-bottom:1px solid #e7cfd8}
    .product-img{width:286px;height:286px;object-fit:cover;border-radius:16px;display:block;cursor:pointer}

    .product-right{flex:1;display:flex;flex-direction:column;min-width:0; position:relative;}

    .title-row{display:flex;align-items:center;justify-content:flex-start;margin-top:0px}

.product-name{
 font-family: 'Lustria', serif;
  font-size: 48px;
  font-weight: 400;
  color: #333;

  display:flex;
  flex-direction:column;
  width:100%;
  position: relative;
  top: 44px;   /* 下に10px */
  }

   /* カテゴリーネーム（属名など） */
.category-name {
  color: #555;
margin-bottom:px;
}

/* バリエティーネーム（品種名） */
.variety-name {
  
   /* 左マージン自動で右端に寄せる */
  text-align: right;       /* 内部テキストも右寄せ */
  white-space: nowrap;     /* 折り返しなし */
  direction: ltr;          /* 文字順は通常のまま（重要） */
margin-top:-10px;
}

    .mid{margin:10px 0 12px;display:flex;align-items:center;justify-content:space-between;gap:12px}

    .price{font-size:38px;font-weight:400;margin-top:20px; position: relative;
  top: 30px;  font-family: 'DM Serif Text', serif;}

    

    .bottom-row{margin-top:30px;display:flex;align-items:center;gap:40px;flex-wrap:nowrap}
 .like-btn{width:66px;height:66px;border-radius:50%;border:2px solid #e91e63;background:none;color:#e91e63none;font-size:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex:0 0 auto}
    .like-btn.liked{background:#F8C6DC;color:#fff}

    /* --- 数量（ネイティブselectは保持するが非表示） --- */
    .qty-wrap{flex:0 0 auto; position:relative;}
    .qty-select{display:none;}

    .qty-display{
      height:65px; padding:0 50px; width:150px;
      border:1px solid #e7e7e7; border-radius:16px; background:#fff;
      font-size:33px; line-height:65px; text-align:center; cursor:pointer;
      position:relative;
    }
    .qty-display::after{
      content:""; position:absolute; right:18px; top:50%; width:8px; height:8px;
      transform:translateY(-50%) rotate(45deg);
      border-right:2px solid #888; border-bottom:2px solid #888;
    }

    .qty-menu{
      position:absolute; left:0; top:0;
      width:150px; max-height:350px; overflow:auto;
      background:#fff; border:2px solid #e7e7e7; border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.08); display:none; z-index:30;
    }
    .qty-menu.show{display:block;}
    .qty-item{padding:10px 0; text-align:center; font-size:33px; cursor:pointer;}
    .qty-item:hover{background:#f6f6f6}

    .add-btn{
      height:65px !important;
      min-width:180px !important;
      padding:0 50px !important;
      border:px solid #999;
      border-radius:28px;
      background:#FFD814;
      color:#0F1111;
opacity:;
      font-weight:300;
      font-size:30px !important;
      line-height:65px;
      white-space:nowrap;
      cursor:pointer;
      flex:0 0 auto;
    }



    /* モーダル（画像拡大） */
    #modal{display:none;position:fixed;inset:0;z-index:10;background:rgba(0,0,0,.7)}
    #modal img{display:block;max-width:80%;max-height:80%;margin:200px auto 50px;border:4px solid #fff}

    /* iPhone幅の微調整 */
    @media (max-width:480px){
      .product-name{font-size:34px}
      .price{font-size:32px}
      .subtext{font-size:22px}
      .add-btn{font-size:20px}
      .info-panel{ position:static; width:100%; max-height:none; overflow:visible; }
    }


/* いいねボタンの枠線だけをグレーに */
.like-btn {
  border: 1px solid #999; /* 枠だけグレー */
  color: inherit;         /* 中身の色は変えない */
  background: none;       /* 背景も変えない */
}

 
  

/* いいね未選択（♡）の文字色だけグレーに */
.like-btn:not(.liked) { color:#999 !important; }

.category-subtitle {
  font-size: 48px;
  font-family: 'Playfair Display SC', serif;
  margin: 66px 0 10px;
  color: #000000;
  font-weight: 400;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  padding-bottom: 4px;
text-align:center;
}
.contact-links a {
  color: #000;     
  text-decoration: none; /* 下線消し */
}

    .img-track{
      width:286px; height:286px; border-radius:16px; overflow:auto;
      scroll-snap-type:x mandatory;
      display:flex; gap:0;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .img-track::-webkit-scrollbar{ display:none; }

    .img-track .product-img{
      flex:0 0 286px; height:286px; object-fit:cover; border-radius:16px;
      scroll-snap-align:start; display:block; cursor:pointer;
    }

    /* ドット（固定配置） */
.img-pager{
  position: static;              /* ← 通常フローに戻す（画像の直後＝真下） */
  width: 286px;
  display: flex; gap: 8px; justify-content: center; align-items: center;
  margin-top: 8px;               /* 見切れ防止の最小スペース（数値は据え置きOK） */
}
    .img-pager .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background:#ccc; opacity:.7;
    }
    .img-pager .dot.active{ background:#333; opacity:1; }

    /* 画像ラッパー（下寄せ） */
.img-wrapper{
  width: 286px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;    /* ← 子要素（トラックとドット）を中央に */
  align-self: stretch;
  /* 無効だった padding-bottom: px は削除（見た目不変） */
}

 


/* 在庫ラベル（ざいこらべる：在庫表示の見た目） */
.stock-label{
  font-size:36px;
  color:#2e7d32; /* 深めのグリーン */
  margin-left:12px;
transform: translateY(33px);
font-weight: 200;
}

/* Sold Out ラベル（売り切れ表示） */
.sold-out-label{
  font-size:36px;
  font-weight:400;
  color:#b00020; /* 赤系 */
  padding:10px 18px;
  border:2px solid #b00020;
  border-radius:16px;margin-left:auto;
　
}


/* 並び替え枠全体を横並びに */
.sort-area {
  display: flex;
  justify-content: space-between;
  align-items: center;

  font-size: 20px; /* 全体の文字を大きめに */
}


.sort-info {
  margin-left: auto;     /* ← 右端まで押し出す */
  text-align: right;     /* ← 行頭も右揃え */
  max-width: 66%;        /* ← 横に広がりすぎないように半分に制限 */
  font-size: 22px;
  color: #333;
  line-height: 1.7;opacity:0.66;
}

/* 下のアンダーライン */
.sort-area {
  border-bottom: 2px solid #F564A970;
  margin-bottom: 16px;
  padding-top: 66px;
}



/* ▼ 新：並べ替えトリガー（枠なし） */
.sort-trigger{
  appearance:none; background:none; border:none; padding:8px 0;
  font-family:'Playfair Display SC','Lustria','Noto Serif JP',serif;
  font-weight:300; font-size:38px; color:#333; cursor:pointer;margin-left:33px;
}
.sort-trigger .chev{
  display:inline-block; margin-left:6px; transform:translateY(-1px) rotate(0deg);
  transition:transform .18s ease;
}
.sort-trigger[aria-expanded="true"] .chev{ transform:translateY(-1px) rotate(90deg); } /* ＞をくるっと */

/* ▼ 新：並べ替えパネル（ハンバーガーと同質感） */
.sort-panel{
  position:fixed; left:0; top:0;           /* top はJSでボタンの真下に合わせる */
  width:100vw;
  height:auto;                              /* ★中身に合わせる */
  min-height:300px;                         /* ★見える最低ライン */
  max-height:70vh;                          /* ★画面の7割まで。多いときは中でスクロール */
  overflow:auto;                            /* ★中だけスクロール */
  background-color:rgba(255,255,255,.7);
  border:2px solid rgba(0,0,0,.1);
  box-shadow:4px 0 20px rgba(0,0,0,.2);
  transform:translateX(-100%); opacity:0; pointer-events:none;
  transition:transform .4s ease, opacity .4s ease;
  z-index:3000; padding:20px 30px;
}
.sort-panel.show{
  transform:translateX(0); opacity:1; pointer-events:auto;
  backdrop-filter:blur(8px);               /* すりガラス */
}

/* 中の項目は category-menu 風 */
.sort-panel .sort-item{
  font-family:'Lustria','Noto Serif JP',serif;
  font-size:32px; color:#000; cursor:pointer; padding:14px 0;
  border-bottom:1px solid rgba(0,0,0,.08);
opacity: 0.7;
}
.sort-panel .sort-item:hover{ color:#c2185b; transform:translateX(2px); }


/* === カテゴリーのタグ行（最初の商品カードの前に出す小さな帯） === */
.cat-tag-row{
  display: block;
  margin: 200px 0 8px;
  padding-left: 20px;         /* 商品リスト左寄せに合わせるだけ（見た目崩さない） */
}

.cat-tag{
  display: inline-block;
  font-family: 'Lustria','Noto Serif JP',serif;
  font-size: 63px;
  line-height: 1;
  padding: 10px 18px;
  color: #000;
  user-select: none;
  white-space: nowrap;
border-bottom: 2px solid #00000050;
opacity:0.6;
}

  </style>



























</head>
<body>
  <div class="header-bar" id="titleBar">
    <button class="menu-icon" onclick="toggleMenu(event)">
      <span></span><span></span><span></span>
    </button>
    <div class="main-title" onclick="window.top.location.href='<?= url ?>?page=index'">nursery sera</div>
    <button class="cart-button" onclick="go('/?page=cart')">
  <span id="cartBadge" class="cart-badge">0</span>
</button>
  </div>

  <!-- スライドメニュー -->
  <div class="category-menu" id="categoryMenu">
    <h1 class="category-header">MENU</h1>
<h2 class="category-subtitle">Category</h2>
    <ul>
      <li onclick="go('/?page=index')">All</li>
      <li onclick="go('/?page=index&liked=1')">like♡</li>
      <li onclick="go('/?page=index&cat=monstera')">Monstera</li>
      <li onclick="go('/?page=index&cat=alocasia')">Alocasia</li>
      <li onclick="go('/?page=index&cat=anthurium')">Anthurium</li>
      <li onclick="go('/?page=index&cat=philodendron')">Philodendron</li>
</ul>
<h2 class="category-subtitle">Contact</h2>
<ul class="contact-links">
  <li><a href="https://www.instagram.com/nursery_sera?igsh=cWx2cTZ3cWNicGlz&utm_source=" target="_blank">Instagram</a></li>
  <li><a href="https://lin.ee/mFSu5FS" target="_blank">LINE</a></li>
  <li><a href="https://www.threads.net/@nursery_sera?igshid=NTc4MTIwNjQ2YQ==" target="_blank">Threads</a></li>
  <li><a href="/?page=policy">お問い合わせ</a></li>
</ul>
  </div>
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <main>
    <p class="subtitle1">plant list</p>

    <!-- 上部ボタン & カテゴリ -->
    <section class="container top-row">
      <div id="topCategories" class="categories">
        <button class="pill" onclick="filterCategory('all')">All</button>
 <button class="like-only" onclick="filterLiked()" title="いいねだけ">like♡</button>
        <button onclick="filterCategory('monstera')">Monstera</button>
        <button onclick="filterCategory('alocasia')">Alocasia</button>
        <button onclick="filterCategory('anthurium')">Anthurium</button>
        <button onclick="filterCategory('philodendron')">Philodendron</button>
      </div>
    </section>

<section class="container">
  <div class="sort-area">
<button id="sortTrigger"
        class="sort-trigger"
        aria-haspopup="listbox"
        aria-expanded="false"
        aria-controls="sortPanel"
        title="並べ替え"
        data-default-label="並べ替え">並べ替え<span class="chev">＞</span></button>

<div id="sortPanel" class="sort-panel" role="listbox" aria-label="並び替えメニュー">
  <div class="sort-item" role="option" data-value="original">品種順</div>
  <div class="sort-item" role="option" data-value="price-asc">価格の安い順</div>
  <div class="sort-item" role="option" data-value="price-desc">価格の高い順</div>
  <div class="sort-item" role="option" data-value="in-stock">在庫あり</div>
</div>

    <div class="sort-info">
      画像をタップすると拡大表示されます。<br>画像1枚目は参考親株、2枚目は参考TC株です。
<br>
      組織培養株のため、購入後は順化作業が必要となります。
    </div>
  </div>
</section>

    <!-- 商品カード（既存1件はそのまま） -->
    <section class="container">
      <!-- ▼▼▼ ここに追加商品がReactで入る ▼▼▼ -->
      <div id="product-root"></div>
      <!-- ▲▲▲ ここに追加商品がReactで入る ▲▲▲ -->
    </section>

    <!-- 画像拡大モーダル -->
    <div id="modal" onclick="this.style.display='none'"><img id="modal-img" src=""></div>
  </main>

  <!-- フッター -->
  <footer>

    <div class="footer-links">
      <a href="<?= url ?>?page=form"></a>
      <a href="/?page=policy">お問い合わせ</a>
      <a href="/?page=policy">各種ポリシー</a>
      <a href="/?page=policy">利用規約</a>
      <a href="/?page=policy">特定商取引法に基づく表記</a>
    </div>
  </footer>

<script>
  /* ===== 元のJS（関数は変更しない） ===== */
  const BASE = window.location.origin;
  function go(path){
    window.location.href = new URL(path, BASE).toString();
  }

  function toggleMenu(event){
    const menu = document.getElementById("categoryMenu");
    const overlay = document.getElementById("overlay");
    const isVisible = menu.classList.contains("show");
    document.body.style.overflow = isVisible ? "" : "hidden";
    menu.classList.toggle("show", !isVisible);
    overlay.classList.toggle("show", !isVisible);
  }
  function closeMenu(){
    document.getElementById("categoryMenu").classList.remove("show");
    document.getElementById("overlay").classList.remove("show");
    document.body.style.overflow = "";
  }




let lastScrollY = window.scrollY;
const titleBar  = document.getElementById("titleBar");
const threshold = 10;

// 初期表示位置は0に固定
titleBar.style.transform = "translateY(0)";

/* ===== トップ付近の許容幅 ===== */
let HEADER_SHOW_OFFSET = 0;
function updateHeaderOffset() {
  const h = titleBar?.getBoundingClientRect().height || 0;
  const EXTRA = 20; // ← 本来の位置より下で表示させたい余白(px)
  HEADER_SHOW_OFFSET = h + EXTRA;
}
document.addEventListener('DOMContentLoaded', updateHeaderOffset);
window.addEventListener('resize', updateHeaderOffset);

/* ===== フェード時間（調整可能） ===== */
const SHOW_FADE_MS = 1000; // フェードイン(ms)
const HIDE_FADE_MS = 200;  // フェードアウト(ms)

/* ===== タッチ・慣性状態 ===== */
let isTouching   = false; // 指が画面に触れている間 true
let inertiaMode  = false; // 慣性スクロール中 true（rAFで検出）
let inertiaUpPx  = 0;     // 慣性中の「上方向」連続移動距離
const INERTIA_MIN_UP_PX = 1; // 慣性で出すのに必要な上向き距離

/* ===== 慣性検出（初速に依存しない / rAF 監視） ===== */
let inertiaWatchOn = false;
let lastRAFScrollY = window.scrollY;
let stableFrames   = 0;
const STABLE_FRAMES_TO_STOP = 4; // 停止判定フレーム数
const MOVE_EPSILON = 1;        // スクロール変化の最小検出量(px)

function startInertiaWatch(){
  if (inertiaWatchOn) return;
  inertiaWatchOn = true;
  lastRAFScrollY = window.scrollY;
  stableFrames = 0;

  (function loop(){
    if (!inertiaWatchOn) return;

    const y  = window.scrollY;
    const dy = y - lastRAFScrollY;

    // 指が付いたら慣性は即終了（カウンター対策）
    if (isTouching) {
      inertiaMode    = false;
      inertiaWatchOn = false;
      return;
    }

    if (Math.abs(dy) > MOVE_EPSILON) {
      // 指が離れていてスクロールが続いている → 慣性中
      inertiaMode  = true;
      stableFrames = 0;
    } else {
      // 動きが止まっているフレームが続いた → 慣性終了
      stableFrames++;
      if (stableFrames >= STABLE_FRAMES_TO_STOP) {
        inertiaMode    = false;
        inertiaWatchOn = false;
        return;
      }
    }

    lastRAFScrollY = y;
    requestAnimationFrame(loop);
  })();
}

/* ===== タッチ状態（captureで最優先） ===== */
document.addEventListener('touchstart', () => {
  isTouching     = true;
  inertiaMode    = false; // 慣性を強制終了（折り返しでの誤発火を防止）
  inertiaUpPx    = 0;
  inertiaWatchOn = false; // rAF監視も停止
  lastScrollY    = window.scrollY; // diff暴発防止
}, { capture:true, passive:true });

document.addEventListener('touchmove', () => {
  isTouching = true;
}, { capture:true, passive:true });

document.addEventListener('touchend', () => {
  isTouching  = false;
  inertiaMode = false;   // ここでは未確定
  inertiaUpPx = 0;
  startInertiaWatch();   // 実際に動いていれば慣性ONになる（初速依存なし）
}, { capture:true, passive:true });

document.addEventListener('touchcancel', () => {
  isTouching  = false;
  inertiaMode = false;
  inertiaUpPx = 0;
  startInertiaWatch();
}, { capture:true, passive:true });

/* ===== マウス/キーボードは即表示/非表示 ===== */
document.addEventListener('wheel', (e) => {
  if (e.deltaY < 0) {
    titleBar.style.transitionDuration = `${SHOW_FADE_MS}ms`;
    titleBar.classList.remove('is-hidden');
  } else if (e.deltaY > 0) {
    titleBar.style.transitionDuration = `${HIDE_FADE_MS}ms`;
    titleBar.classList.add('is-hidden');
  }
}, { passive:true });

document.addEventListener('keydown', (e) => {
  const showKeys = ['ArrowUp', 'PageUp', 'Home'];
  const hideKeys = ['ArrowDown', 'PageDown', 'End', ' '];
  if (showKeys.includes(e.key)) {
    titleBar.style.transitionDuration = `${SHOW_FADE_MS}ms`;
    titleBar.classList.remove('is-hidden');
  } else if (hideKeys.includes(e.key)) {
    titleBar.style.transitionDuration = `${HIDE_FADE_MS}ms`;
    titleBar.classList.add('is-hidden');
  }
});

/* ===== スクロール本体 ===== */
window.addEventListener("scroll", () => {
  const current = window.scrollY;
  const diff    = current - lastScrollY; // +:下 / -:上
  if (Math.abs(diff) < threshold) { lastScrollY = current; return; }

  // 最上部〜ヘッダー高さ+余白までは必ず表示（例外）
  if (current <= HEADER_SHOW_OFFSET) {
    titleBar.style.transitionDuration = `${SHOW_FADE_MS}ms`;
    titleBar.classList.remove('is-hidden');
    titleBar.style.transform = "translateY(0)";
    inertiaUpPx = 0;
    lastScrollY = current;
    return;
  }

  if (diff > 0) {
    // ▼ 下方向：即隠す（従来通り）
    titleBar.style.transitionDuration = `${HIDE_FADE_MS}ms`;
    titleBar.classList.add('is-hidden');

    // 慣性中でも下に触れたら上向き累計はリセット（連続条件を保持）
    if (inertiaMode) inertiaUpPx = 0;
  } else {
    // ▼ 上方向
    if (isTouching) {
      // 指が付いている間は絶対に出さない（何もしない）
    } else if (inertiaMode) {
      // 慣性中のみ、上方向の連続距離を加算
      inertiaUpPx += Math.abs(diff);

      // しきい値に達したら表示（1回出したら距離リセット）
      if (inertiaUpPx >= INERTIA_MIN_UP_PX) {
        titleBar.style.transitionDuration = `${SHOW_FADE_MS}ms`;
        titleBar.classList.remove('is-hidden');
        titleBar.style.transform = "translateY(0)";
        inertiaUpPx = 0;
        // 慣性は続いていても、次に再表示させるには再度距離を貯める
      }
    }
    // 慣性でない（＝PC操作など）の上スクロールは wheel/keydown 側で即表示済み
  }

  lastScrollY = current;
}, { passive:true });


  function enlargeImage(img){
    const m=document.getElementById('modal'), mi=document.getElementById('modal-img');
    mi.src=img.src; m.style.display='block';
  }

  // ===== カテゴリフィルタ（.category-name の文字で判定） =====
 function filterCategory(category){
  const likes = JSON.parse(localStorage.getItem('likes') || '{}');
  const target = String(category || '').toLowerCase();

  // ▼ 商品カードの表示制御（既存ロジック）
  document.querySelectorAll('.product-item').forEach(item=>{
    const cnameEl = item.querySelector('.category-name');
    const itemCategory = (cnameEl?.textContent || '').trim().toLowerCase();

    let itemId = item.getAttribute('data-id');
    if (!itemId) {
      const likeBtn = item.querySelector('.like-btn[id^="like-"]');
      if (likeBtn) itemId = likeBtn.id.replace('like-','');
    }

    if (target === 'all') {
      item.style.display = 'flex';
    } else if (target === 'liked') {
      item.style.display = (itemId && likes[itemId]) ? 'flex' : 'none';
    } else {
      item.style.display = (itemCategory === target) ? 'flex' : 'none';
    }
  });

  // ▼ カテゴリー“タグ行”の表示制御を追加
  document.querySelectorAll('.cat-tag-row').forEach(tagRow=>{
    const rowCat = (tagRow.getAttribute('data-category') || '').toLowerCase();
    if (target === 'all') {
      // そのカテゴリに該当する商品が一つも表示されていなければタグも隠す
      const hasVisible = !!document.querySelector(`.product-item[data-category="${rowCat}"]`)
        && Array.from(document.querySelectorAll(`.product-item[data-category="${rowCat}"]`))
             .some(el => el.style.display !== 'none');
      tagRow.style.display = hasVisible ? 'block' : 'none';
    } else if (target === 'liked') {
      // like表示では全タグをいったん非表示（必要なら後で拡張可）
      tagRow.style.display = 'none';
    } else {
      // 対象カテゴリのタグだけ表示
      tagRow.style.display = (rowCat === target) ? 'block' : 'none';
    }
  });

  // ★追加：Allのときは「タグ→同カテゴリの商品」になるようにDOMを再グルーピング
  if (target === 'all') {
    regroupAll();
  }
}
  window.filterCategory = filterCategory; // HTMLから呼べるように公開

  function filterLiked(){
    const likes=JSON.parse(localStorage.getItem('likes')||'{}');
    document.querySelectorAll('.product-item').forEach((it,idx)=>{
      const id=String(idx+1).padStart(3,'0');
      it.style.display = likes[id] ? 'flex' : 'none';
    });
  }
  window.filterLiked = filterLiked;

  function toggleLike(shortId){
    const likes=JSON.parse(localStorage.getItem('likes')||'{}');
    const id='like-'+shortId;
    const btn=document.getElementById(id);
    const liked = !likes[shortId];
    likes[shortId]=liked;
    localStorage.setItem('likes',JSON.stringify(likes));
    btn.classList.toggle('liked', liked);
    btn.textContent = liked ? '♥' : '♡';
  }

function addToCart(id, name, price){
  const sel = document.getElementById('qty-'+id);
  const q = parseInt(sel?.value || '1') || 1;

  const card     = document.querySelector(`[id="qty-${id}"]`)?.closest('.product-item');
  const img      = card?.querySelector('.product-img')?.getAttribute('src') || '';
  const category = (card?.querySelector('.category-name')?.textContent || '').trim();
  const variety  = (card?.querySelector('.variety-name')?.textContent  || '').trim();

  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const idx  = cart.findIndex(i => i.id === id);

  if (idx > -1) {
    // 既にあるなら加算
    cart[idx].quantity = (Number(cart[idx].quantity) || 0) + q;
  } else {
    cart.push({
      id,
      name    : variety || name || '',
      price   : Number(price) || 0,
      quantity: q,
      image   : img,
      category,
      variety
    });
  }
  localStorage.setItem('cart', JSON.stringify(cart));

  const total = (cart.find(i => i.id === id)?.quantity) || q;
  alert(`${variety || name} を ${q} 株カートに追加しました。`);

  // ★ここで数量を 1 にリセット
  if (sel) sel.value = '1';
  const display = document.querySelector(`.qty-display[data-for="qty-${id}"]`);
  if (display) display.textContent = '1';
updateCartBadge();
}

  // ===== infoボタン（i）でパネルの開閉 =====
  document.querySelectorAll('.info-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const card = btn.closest('.product-right');
      const panel = card?.querySelector('.info-panel');
      const subTxt = card?.querySelector('.subtext');
      if(!panel) return;
      document.querySelectorAll('.info-panel.show').forEach(p=>{
        if(p!==panel) p.classList.remove('show');
      });
      if(subTxt){
        panel.style.top = subTxt.offsetTop + 'px';
      }else{
        const mid = card?.querySelector('.mid');
        if(mid) panel.style.top = mid.offsetTop + 'px';
      }
      panel.classList.toggle('show');
      btn.setAttribute('aria-expanded', panel.classList.contains('show'));
    });
  });

  // ===== 数量セレクタの初期化（既存カード用） =====
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.qty-select').forEach(sel=>{
      sel.innerHTML='';
      for(let i=1;i<=100;i++){
        const op=document.createElement('option');
        op.value=i; op.textContent=i;
        sel.appendChild(op);
      }
      // localStorage(cart) から数量復元（なければ1）
      // ★リロード時も必ず1にする（cartは無視）
if (sel) sel.value = '1';
if (dsp) dsp.textContent = '1';
    });

    document.querySelectorAll('.qty-display').forEach(btn=>{
      const forId = btn.getAttribute('data-for');
      const sel = document.getElementById(forId);
      const menu = btn.parentElement.querySelector(`.qty-menu[data-for="${forId}"]`);
      if(menu && menu.children.length===0){
        for(let i=1;i<=100;i++){
          const it=document.createElement('div');
          it.className='qty-item';
          it.textContent=i;
          it.addEventListener('click', ()=>{
            sel.value=String(i);
            btn.textContent=String(i);
            menu.classList.remove('show');
          });
          menu.appendChild(it);
        }
      }
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        document.querySelectorAll('.qty-menu.show').forEach(m=>{ if(m!==menu) m.classList.remove('show'); });
        menu.classList.toggle('show');
      });
    });

    document.addEventListener('click', ()=>{
      document.querySelectorAll('.qty-menu.show').forEach(m=>m.classList.remove('show'));
    });
  });

(function(){
  const MIN_PX = 14;
  function fitName(el){
    let size = parseFloat(getComputedStyle(el).fontSize);
    let guard = 60;
    while (el.scrollWidth > el.clientWidth && size > MIN_PX && guard-- > 0){
      size -= 1;
      el.style.fontSize = size + 'px';
    }
  }
  function fitAll(){
    document.querySelectorAll('.product-name').forEach(el=>{
      el.style.fontSize = '';
      fitName(el);
    });
  }
  document.addEventListener('DOMContentLoaded', fitAll);
  window.addEventListener('load', fitAll);
  // resize の呼びすぎを抑制（すろっとる + rAF）
  (function(){
    let ticking = false;
    let last = 0;
    const MIN_INTERVAL = 150;
    window.addEventListener('resize', () => {
      const now = Date.now();
      if (ticking || (now - last) < MIN_INTERVAL) return;
      ticking = true; last = now;
      requestAnimationFrame(() => { fitAll(); ticking = false; });
    }, { passive: true });
  })();

  // ★追加：React が商品を描画し終えた合図（カスタムイベント）でも実行
  document.addEventListener('products-rendered', fitAll);
})();

  /* ===== GAS依存を静的環境で吸収する“互換シム” ===== */
  (function(){
    // 1) main-title の GAS 依存 onclick を上書き
    const title = document.querySelector('.main-title');
    if (title) {
      title.addEventListener('click', function(ev){
        ev.preventDefault();
        try { go('/?page=index'); } catch(e){ window.location.href='/?page=index'; }
      }, { once:true });
    }

    // 2) href の <?= url ?> を /?page=... に変換
    document.querySelectorAll('a[href*="<?= url ?>"]').forEach(a=>{
      const href = a.getAttribute('href');
      const m = href.match(/\?page=.*$/);
      a.setAttribute('href', m ? m[0] : '/');
    });

    // 3) 空の a[href^='<?= url ?>'] は無効化
    document.querySelectorAll('a[href^="<?= url ?>"]').forEach(a=>{
      if (!a.textContent.trim()) {
        a.setAttribute('tabindex','-1');
        a.style.pointerEvents = 'none';
      }
    });

    // 4) 同一タブで遷移
    const base = document.querySelector('base');
    if (base) base.setAttribute('target','_self');
  })();

  // ===== like の見た目復元 =====
  document.addEventListener('DOMContentLoaded', () => {
    const likes = JSON.parse(localStorage.getItem('likes') || '{}');
    Object.entries(likes).forEach(([shortId, liked]) => {
      const btn = document.getElementById('like-' + shortId);
      if (!btn) return;
      btn.classList.toggle('liked', !!liked);
      btn.textContent = liked ? '♥' : '♡';
    });
  });

  // ===== カテゴリメニュー（サイド/上部）の連携 =====
  document.addEventListener('DOMContentLoaded', () => {
    // 表示名→内部キーの対応（大文字小文字は無視）
    const map = {
      'all': 'all',
      'monstera': 'monstera',
      'alocasia': 'alocasia',
      'anthurium': 'anthurium',
      'philodendron': 'philodendron',
      'liked': 'liked'
    };

    // （※上部の横スクロールに .category-btn があれば拾う：無くても無害）
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');
        filterCategory(category);
        updateURL(category);
      });
    });

    // ハンバーガーメニューの li をクリックでフィルタ
    const menu = document.getElementById('categoryMenu');
    if (menu) {
      menu.querySelectorAll('li').forEach(li => {
        let category = (li.getAttribute('data-category') || '').trim().toLowerCase();

        if (!category) {
          const txt = (li.textContent || '').trim().toLowerCase();
          if (txt.includes('♡') || txt.includes('♥')) category = 'liked';
          else if (map[txt]) category = txt;
        }

        if (!category) {
          const oc = li.getAttribute('onclick') || '';
          const m1 = oc.match(/cat=([a-z]+)/i);
          const m2 = oc.match(/liked=1/);
          if (m1 && map[m1[1].toLowerCase()]) category = m1[1].toLowerCase();
          if (m2) category = 'liked';
        }

        if (!category) return;

        // 既存の go(...) を無効化して、その場でフィルタ
        li.removeAttribute('onclick');
        li.onclick = null;

        li.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          filterCategory(category);
          updateURL(category);
          if (typeof closeMenu === 'function') closeMenu();
          document.getElementById('topCategories')?.scrollIntoView({ behavior:'smooth', block:'nearest' });
        }, { capture:true });
      });
    }

    // 現在の絞り込みに合わせてURLだけ更新（リロードなし）
    function updateURL(category){
      const url =
        category === 'all'   ? '/?page=index' :
        category === 'liked' ? '/?page=index&liked=1' :
                               `/?page=index&cat=${encodeURIComponent(category)}`;
      history.replaceState(null, '', url);
    }

    // 直アクセス（/?page=index&liked=1 or &cat=...）時にも反映
    const params = new URLSearchParams(location.search);
    if (params.get('liked') === '1') {
      filterCategory('liked');
    } else {
      const initCat = (params.get('cat') || 'all').toLowerCase();
      filterCategory(map[initCat] ? initCat : 'all');
    }
  });

  // ===== 画像のページドット（静的に最初からあるカード用） =====
  document.addEventListener('DOMContentLoaded', () => {
    const init = (wrap) => {
      const track = wrap.querySelector('.img-track');
      const pager = wrap.querySelector('.img-pager');
      if (!track || !pager) return;

      const imgs = track.querySelectorAll('.product-img');
      if (!imgs.length) return;

      // ドット生成
      pager.innerHTML = '';
      imgs.forEach((_, i) => {
        const dot = document.createElement('span');
        dot.className = 'dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => {
          const w = imgs[0].getBoundingClientRect().width;
          track.scrollTo({ left: i * w, behavior: 'smooth' });
        });
        pager.appendChild(dot);
      });

      // スクロール位置から active 同期
      const updateActive = () => {
        const w = imgs[0].getBoundingClientRect().width || 1;
        const idx = Math.round(track.scrollLeft / w);
        pager.querySelectorAll('.dot').forEach((d, j) => {
          d.classList.toggle('active', j === idx);
        });
      };

      track.addEventListener('scroll', () => requestAnimationFrame(updateActive));
      window.addEventListener('resize', updateActive);
      updateActive();
    };

    const wraps = document.querySelectorAll('.img-wrapper');
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries, obs) => {
        entries.forEach(e => {
          if (e.isIntersecting) { init(e.target); obs.unobserve(e.target); }
        });
      }, { rootMargin: '200px' });
      wraps.forEach(w => io.observe(w));
    } else {
      wraps.forEach(init);
    }
  });
</script>

<!-- ===== React (UMD) を追加 ===== -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

<!-- ===== Firebaseで取得 → Reactで商品だけ描画（既存CSS/関数は不変更） ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // あなたのFirebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyCVOfVGTlfTGRfpNggT55l3raCqjo7OcBo",
    authDomain: "nursery-9bd14.firebaseapp.com",
    projectId: "nursery-9bd14",
    storageBucket: "nursery-9bd14.firebasestorage.app",
    appId: "1:123851517861:web:42afa474c5b6d62669024c"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const { useEffect, useRef } = React;

  // varietyName をIDに（英数・日本語対応の簡易スラッグ化）
  const toId = (str, fallback) => {
    const s = (str || '').toString().trim().toLowerCase()
      .replace(/[^\p{L}\p{N}]+/gu, '-')   // 文字以外→ハイフン
      .replace(/^-+|-+$/g, '');           // 先頭末尾のハイフン除去
    return s || (fallback || '');
  };

  // ==== 1商品カード（既存の関数をそのまま呼ぶ）====
function ProductCard({ d, id }) {
  const imgs   = Array.isArray(d.images) ? d.images.slice(0, 2) : [];
  const price  = Number(d.price || 0);
  const status = (d.status || 'available'); // 'available' | 'soldout'（在庫状態）

  const trackRef = useRef(null);
  const pagerRef = useRef(null);

  // ページドット生成（既存ロジックそのまま）
  useEffect(() => {
    const track = trackRef.current;
    const pager = pagerRef.current;
    if (!track || !pager) return;

    const pics = track.querySelectorAll('img.product-img');
    pager.innerHTML = '';
    if (pics.length > 0) {
      pics.forEach((_, i) => {
        const dot = document.createElement('span');
        dot.className = 'dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => {
          const w = pics[0].getBoundingClientRect().width || 0;
          track.scrollTo({ left: w * i, behavior: 'smooth' });
        });
        pager.appendChild(dot);
      });
      const updateActive = () => {
        const w = pics[0].getBoundingClientRect().width || 1;
        const idx = Math.round(track.scrollLeft / w);
        [...pager.children].forEach((d, j) => d.classList.toggle('active', j === idx));
      };
      track.addEventListener('scroll', () => requestAnimationFrame(updateActive), { passive: true });
      window.addEventListener('resize', updateActive);
      updateActive();
      return () => window.removeEventListener('resize', updateActive);
    }
  }, [id]);

  // いいね＆数量の復元（既存ロジックそのまま）
  useEffect(() => {
    const likes = JSON.parse(localStorage.getItem('likes') || '{}');
    const btnLike = document.getElementById('like-' + id);
    const liked = !!likes[id];
    if (btnLike) {
      btnLike.classList.toggle('liked', liked);
      btnLike.textContent = liked ? '♥' : '♡';
    }

    const sel  = document.getElementById(`qty-${id}`);
    const dsp  = document.querySelector(`.qty-display[data-for="qty-${id}"]`);
    const menu = document.querySelector(`.qty-menu[data-for="${`qty-${id}`}"]`);

    if (sel && !sel.options.length) {
      for (let i = 1; i <= 100; i++) {
        const op = document.createElement('option'); op.value = i; op.textContent = i;
        sel.appendChild(op);
      }
    }
    if (sel) sel.value = '1';
    if (dsp) dsp.textContent = '1';

    if (menu && !menu.children.length) {
      for (let i = 1; i <= 100; i++) {
        const it = document.createElement('div');
        it.className = 'qty-item'; it.textContent = i;
        it.addEventListener('click', () => {
          if (sel) sel.value = String(i);
          if (dsp) dsp.textContent = String(i);
          menu.classList.remove('show');
        });
        menu.appendChild(it);
      }
    }
    const toggleQtyMenu = (e) => { e.stopPropagation(); menu?.classList.toggle('show'); };
    const dspBtn = dsp?.closest('.qty-wrap')?.querySelector('.qty-display');
    dspBtn?.addEventListener('click', toggleQtyMenu);
    const closeAll = () => menu?.classList.remove('show');
    document.addEventListener('click', closeAll);
    return () => {
      dspBtn?.removeEventListener('click', toggleQtyMenu);
      document.removeEventListener('click', closeAll);
    };
  }, [id]);

  return React.createElement('article',
    { className: 'product-item', 'data-category': (d.categoryName || '').toLowerCase(), 'data-id': id },

    // 画像
    React.createElement('div', { className: 'img-wrapper' },
      React.createElement('div', { className: 'img-track', ref: trackRef },
        (imgs.length ? imgs : ['']).map((src, i) =>
          React.createElement('img', {
            key: i, className: 'product-img',
            src: src || 'data:image/gif;base64,R0lGODlhAQABAAAAACw=',
            alt: `${d.categoryName || ''} ${d.varietyName || ''} #${i + 1}`,
            loading: 'lazy',
            decoding: 'async',
            width: 286, height: 286,
            onClick: (ev) => window.enlargeImage?.(ev.target)
          })
        )
      ),
      React.createElement('div', { className: 'img-pager', ref: pagerRef })
    ),

    // 右側
    React.createElement('div', { className: 'product-right' },

      // タイトル
      React.createElement('div', { className: 'title-row' },
        React.createElement('div', { className: 'product-name' },
          React.createElement('div', { className: 'name-spacer' }),
          React.createElement('div', { className: 'category-name' }, d.categoryName || ''),
          React.createElement('div', { className: 'variety-name'  }, d.varietyName  || '')
        )
      ),

      // 価格＋在庫ラベル（infoボタンは廃止）
      // 価格＋在庫ラベル（在庫なし時は何も出さない）
React.createElement('div', { className: 'mid' },
  React.createElement('p', { className: 'price' }, `¥ ${Number(price).toLocaleString()}`),
  status === 'available'
    ? React.createElement('span', { className: 'stock-label' }, '在庫あり')
    : null
),

      // 下段：在庫で分岐
      React.createElement('div', { className: 'bottom-row' },
        React.createElement('button', {
          className: 'like-btn',
          id: `like-${id}`,
          onClick: () => window.toggleLike?.(id),
          'aria-label': 'like'
        }, '♡'),

        status === 'available'
          ? [
              React.createElement('div', { key:'qty', className: 'qty-wrap' },
                React.createElement('select', { id: `qty-${id}`, className: 'qty-select' }),
                React.createElement('div', { className: 'qty-display', 'data-for': `qty-${id}` }, '1'),
                React.createElement('div', { className: 'qty-menu', 'data-for': `qty-${id}` })
              ),
              React.createElement('button', {
                key:'add',
                className: 'add-btn',
                onClick: () => window.addToCart?.(id, `${d.categoryName || ''} ${d.varietyName || ''}`, price)
              }, 'Add to Cart')
            ]
          : React.createElement('span', { key:'soldout', className: 'sold-out-label' }, 'Sold Out')
      )
    )
  );
}

  function ProductList({ items }) {
  // ▼ 並べたい順序（英字キー）と日本語ラベル
  const order = ['monstera','anthurium','philodendron','alocasia'];
  const labelMap = {
    monstera: 'モンステラ',
    anthurium: 'アンスリウム',
    philodendron: 'フィロデンドロン',
    alocasia: 'アロカシア'
  };

  // ▼ カテゴリごとにグループ化
  const groups = {};
  items.forEach(({ id, data }) => {
    const key = String(data.categoryName || '').trim().toLowerCase();
    (groups[key] ||= []).push({ id, data });
  });

  const out = [];

  // ▼ 指定順で描画（各カテゴリの“最初”にタグ行を差し込み）
  order.forEach(key => {
    const arr = groups[key] || [];
    if (!arr.length) return;

    // タグ行（この直後から同カテゴリの1商品目が来る）
    out.push(
      React.createElement('div', {
        key: `tag-${key}`,
        className: 'cat-tag-row',
        'data-category': key
      }, React.createElement('span', { className: 'cat-tag' }, labelMap[key] || key))
    );

    // 商品
    arr.forEach(({ id, data }) => {
      out.push(React.createElement(ProductCard, { key: id, id, d: data }));
    });
  });

  // ▼ 指定外のカテゴリ（万一あれば最後にまとめて表示）
  Object.keys(groups)
    .filter(k => !order.includes(k))
    .forEach(key => {
      const arr = groups[key];
      if (!arr?.length) return;

      out.push(
        React.createElement('div', {
          key: `tag-${key}`,
          className: 'cat-tag-row',
          'data-category': key
        }, React.createElement('span', { className: 'cat-tag' }, key))
      );

      arr.forEach(({ id, data }) => {
        out.push(React.createElement(ProductCard, { key: id, id, d: data }));
      });
    });

  return React.createElement(React.Fragment, null, out);
}

async function renderProducts() {
  const mount = document.getElementById('product-root');
  if (!mount) return;

  let docs = [];
  try {
    const q = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    docs = snap.docs.map(d => {
      const data = d.data();
      return { id: toId(data.varietyName, d.id), data };
    });
  } catch (e) {
    const snap = await getDocs(collection(db, 'products'));
    docs = snap.docs.map(d => {
      const data = d.data();
      return { id: toId(data.varietyName, d.id), data };
    });
  }

  ReactDOM.createRoot(mount).render(
    React.createElement(ProductList, { items: docs })
  );

  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  document.dispatchEvent(new Event('products-rendered'));
}
  

const params = new URLSearchParams(location.search);
const want = (params.get('liked') === '1')
  ? 'liked'
  : (params.get('cat') || 'all').toLowerCase();

document.addEventListener('products-rendered', () => {
  window.filterCategory?.(want);
  document.getElementById('topCategories')?.scrollIntoView({
    behavior: 'instant',
    block: 'nearest'
  });
});
  renderProducts().catch(console.error);
</script>
<script>
   document.addEventListener('DOMContentLoaded', () => {
    const likeOnlyBtn = document.querySelector('.like-only');
    if (likeOnlyBtn) {
      likeOnlyBtn.onclick = null;
      likeOnlyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        filterCategory('liked');
        history.replaceState(null, '', '/?page=index&liked=1');
      });
    }

    // ★追加：上部カテゴリ群の URL も選択に合わせて更新
    const catBtns = document.querySelectorAll('#topCategories button');
    catBtns.forEach((btn) => {
      const label = (btn.textContent || '').trim().toLowerCase();
      btn.onclick = null; // インライン onclick を無効化（filterCategoryはJS側で呼ぶ）

      btn.addEventListener('click', (e) => {
        e.preventDefault();

        if (label === 'all') {
          filterCategory('all');
          history.replaceState(null, '', '/?page=index'); // ← liked=1 を消す
        } else if (label.includes('like')) {
          filterCategory('liked');
          history.replaceState(null, '', '/?page=index&liked=1');
        } else {
          // カテゴリ名をそのまま cat= に反映
          filterCategory(label);
          history.replaceState(null, '', `/?page=index&cat=${encodeURIComponent(label)}`);
        }
      });
    });
  });

// 新規：カート内合計数（数量の合計）を返す
function getCartCount(){
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  return cart.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
}

// 新規：バッジ（ばっじ）を現在の合計数で更新
function updateCartBadge(){
  const el = document.getElementById('cartBadge');
  if (!el) return;
  const count = getCartCount();
  el.textContent = String(count);
  el.style.display = count > 0 ? 'flex' : 'none';
}

// 起動時に一度更新
document.addEventListener('DOMContentLoaded', updateCartBadge);

// 他タブでの変化も拾う（storage：すとれーじ いべんと）
window.addEventListener('storage', (e) => {
  if (e.key === 'cart') updateCartBadge();
});


/* === 並び替え（そーと）処理：React後のDOMを並び替えるだけ === */

/** 価格（かかく）を数値で取得 */
function getCardPrice(card){
  const t = card.querySelector('.price')?.textContent || '';
  const n = t.replace(/[^\d.]/g, '');
  return Number(n) || 0;
}

/** 在庫ありかどうか（sold-outラベルが無ければ在庫あり） */
function isAvailable(card){
  return !card.querySelector('.sold-out-label');
}

/** 並び替え本体
 * @param {'price-asc'|'price-desc'|'in-stock'|''} mode
 *
 * ポイント：
 * - 「在庫あり」選択時は Sold Out を **非表示**（表示しない）。
 * - それ以外に戻したら、**非表示にした分だけ**元の表示状態に戻す
 *   （カテゴリ／likeなど既存の display 状態は保持）。
 */
function applySort(mode){
  const root = document.getElementById('product-root');
  if (!root) return;

  const cards = Array.from(root.querySelectorAll('.product-item'));

  // 初回のみ“元の並び順”を記録（すてーぶる：同点の時に崩れない）
  cards.forEach((c,i)=>{
    if (!c.dataset.originalOrder) c.dataset.originalOrder = String(i);
  });

  // ▼ いったん「在庫で隠したもの」を元に戻す（ほかのモード用）
  cards.forEach(c => {
    if (c.dataset.hiddenByStock === '1') {
      // 以前の display を復元（空文字なら style指定なし）
      c.style.display = c.dataset.prevDisplay ?? '';
      delete c.dataset.prevDisplay;
      delete c.dataset.hiddenByStock;
    }
  });

  // ▼ 並び順の決定（価格系のみ並び替え、在庫ありは“非表示化”だけ）
  const byOriginal = (a,b) =>
    Number(a.dataset.originalOrder) - Number(b.dataset.originalOrder);

  const byPriceAsc  = (a,b) => getCardPrice(a) - getCardPrice(b);
  const byPriceDesc = (a,b) => getCardPrice(b) - getCardPrice(a);

   // ▼ 品種順（＝初期の「タグ→同カテゴリの商品…」構成）に戻す
  if (mode === 'original' || mode === '') {
    markOriginalOrder(); // 念のため（ねんのため：元順記録の再確認）
    regroupAll();        // 再グルーピング（さいぐるーぴんぐ：カテゴリごとに並べ直し）
    return;              // 以降の処理は不要
  }

  if (mode === 'price-asc' || mode === 'price-desc') {
    const sorter = (mode === 'price-asc') ? byPriceAsc : byPriceDesc;
    cards.sort(sorter).forEach(c => root.appendChild(c));
  }

  if (mode === 'in-stock') {
    cards.forEach(c => {
      const soldout = !isAvailable(c);
      if (soldout) {
        // いまの display をメモしてから非表示化（復帰用）
        c.dataset.prevDisplay = c.style.display || '';
        c.style.display = 'none';
        c.dataset.hiddenByStock = '1';
      }
    });
    // 並び順は崩さず（元の順を維持）。必要なら byOriginal で固定化してもOK。
  }
}

// 既存：toggleMenu/closeMenu/overlay はそのまま使用

// 追加：押したボタンの真下にパネルを配置（getBoundingClientRect：げっとばうんでぃんぐ…要素の位置と大きさを取得）
function placeSortPanel(anchor){
  const panel = document.getElementById('sortPanel');
  if (!panel || !anchor) return;

  const r = anchor.getBoundingClientRect();

  // ビューポート基準で“ボタンの真下”に配置
  const desiredTop  = r.bottom;
  let   desiredLeft = r.left;

  // 右にはみ出さないようにクランプ（8px 余白）
  const pw = panel.offsetWidth || 0;
  const maxLeft = Math.max(8, window.innerWidth - pw - 8);
  if (desiredLeft > maxLeft) desiredLeft = maxLeft;

  panel.style.top  = `${desiredTop}px`;
  panel.style.left = `${desiredLeft}-8px`;
}

let _sortAnchor = null; // 直近で押された「並べ替え」ボタン

function openSort(evt){
  const panel   = document.getElementById('sortPanel');
  const overlay = document.getElementById('overlay');
  const anchor  = evt?.currentTarget || document.getElementById('sortTrigger');
  if(!panel || !anchor) return;

  _sortAnchor = anchor;
  placeSortPanel(anchor); // ← “押した場所の真下”に置く

  panel.classList.add('show');
  overlay.classList.add('show');
  anchor.setAttribute('aria-expanded','true');
  document.body.style.overflow = 'hidden';
}

function closeSort(){
  const panel   = document.getElementById('sortPanel');
  const overlay = document.getElementById('overlay');
  if(!panel) return;

  panel.classList.remove('show');
  if (_sortAnchor) {
    _sortAnchor.setAttribute('aria-expanded','false');
  }

  const catOpen = document.getElementById('categoryMenu')?.classList.contains('show');
  if(!catOpen) overlay.classList.remove('show');

  document.body.style.overflow = '';
}

document.addEventListener('DOMContentLoaded', () => {
  const panel   = document.getElementById('sortPanel');
  const overlay = document.getElementById('overlay');

  // すべての並べ替えボタン（.sort-trigger）に対応
  document.querySelectorAll('.sort-trigger').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      panel.classList.contains('show') ? closeSort() : openSort(e);
    });
  });

  if(panel){
    panel.querySelectorAll('.sort-item').forEach(item=>{
      item.addEventListener('click', (e)=>{
        e.stopPropagation();
        const val   = item.dataset.value || '';
        const label = (item.textContent || '').trim();

        applySort(val);

        // 押したボタン側の表示を更新（＞は維持）
        if (_sortAnchor) {
          _sortAnchor.innerHTML = `${label}<span class="chev">＞</span>`;
          _sortAnchor.setAttribute('title', label);
          _sortAnchor.setAttribute('aria-label', label);
        }

        closeSort();

        const url = new URL(location.href);
        if (val) url.searchParams.set('sort', val);
        else     url.searchParams.delete('sort');
        history.replaceState(null, '', url.toString());
      });
    });
  }

  overlay?.addEventListener('click', closeSort);

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeSort();
  });

  // 開いている間だけ、スクロール／リサイズで押したボタンの真下に追従
  const reposition = () => {
    const panel = document.getElementById('sortPanel');
    if(panel?.classList.contains('show') && _sortAnchor){
      placeSortPanel(_sortAnchor);
    }
  };
  window.addEventListener('scroll',  reposition, { passive:true });
  window.addEventListener('resize',  reposition);
});

  // DOM を動かさず“元の順序”だけ記録する関数
  function markOriginalOrder(){
    const root = document.getElementById('product-root');
    if (!root) return;
    const cards = Array.from(root.querySelectorAll('.product-item'));
    cards.forEach((c,i)=>{
      if (!c.dataset.originalOrder) c.dataset.originalOrder = String(i);
    });
  }

  // 初回は並べ替えを実行しない（DOM順＝「タグ→同カテゴリ商品」を維持）
  document.addEventListener('products-rendered', () => {
    markOriginalOrder();
  });

/* === 新規：All押下時に「タグ→同カテゴリの商品…」へ並び替え直す ===
   DOM（どむ：画面要素の木構造）を動かすだけで、データは一切変更しません（べき等：何度実行しても同じ結果） */
function regroupAll(){
  const root = document.getElementById('product-root');
  if (!root) return;

  // 既定のカテゴリ順（初期描画と同じ並び）
  const order = ['monstera','anthurium','philodendron','alocasia'];

  // 既存のタグ行を拾う（後で再配置）
  const tagRows = {};
  root.querySelectorAll('.cat-tag-row').forEach(tr=>{
    const key = (tr.getAttribute('data-category') || '').toLowerCase();
    tagRows[key] = tr;
  });

  // 商品カードをカテゴリごとに収集
  const itemsByCat = {};
  root.querySelectorAll('.product-item').forEach(card=>{
    const key = (card.getAttribute('data-category') || '').toLowerCase();
    (itemsByCat[key] ||= []).push(card);
  });

  // 各カテゴリ内は「元の順番（originalOrder）」で安定ソート（すてーぶる：同点で崩れない）
  Object.keys(itemsByCat).forEach(k=>{
    itemsByCat[k].sort((a,b)=>
      (Number(a.dataset.originalOrder)||0) - (Number(b.dataset.originalOrder)||0)
    );
  });

  // DocumentFragment（どきゅめんとふらぐめんと：まとめて差し替える一時入れ物）で一括再配置
  const frag = document.createDocumentFragment();

   // 既定カテゴリの順に「タグ→商品…」で並べる
  order.forEach(k=>{
    const tag   = tagRows[k];
    const cards = itemsByCat[k] || [];
    if (!tag || cards.length === 0) return; // そのカテゴリに商品が無ければスキップ

    // ☆ポイント：可視カードが1枚以上ある時だけタグを表示
    const hasVisible = cards.some(c => (c.style.display || '') !== 'none');
    tag.style.display = hasVisible ? 'block' : 'none';
    frag.appendChild(tag);

    // ☆ポイント：カードの display は“変更しない”（フィルタ状態を維持）
    cards.forEach(c=>{ frag.appendChild(c); });
  });

  // 想定外カテゴリ（もしあれば最後にまとめる）
  Object.keys(itemsByCat).filter(k=>!order.includes(k)).forEach(k=>{
    const tag   = tagRows[k];
    const cards = itemsByCat[k] || [];

    if (tag) {
      const hasVisible = cards.some(c => (c.style.display || '') !== 'none');
      tag.style.display = hasVisible ? 'block' : 'none';
      frag.appendChild(tag);
    }
    cards.forEach(c=>{ /* displayは維持 */ frag.appendChild(c); });
  });

  // ここで一気に置き換え（reflow最小化：りふろー最小で描画の無駄を抑える）
  root.appendChild(frag);
}

</script>
</body>
</html>